<!DOCTYPE HTML><html lang=""><head><meta charset="UTF-8"><meta content="text/html; charset=utf-8"http-equiv="Content-Type"><title>crypto - Quantum Pyramids Â· GitBook</title><meta content="IE=edge"http-equiv="X-UA-Compatible"/><meta content=""name="description"><meta content="GitBook 3.2.3"name="generator"><link href="../../../../../gitbook/style.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-katex/katex.min.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-disqus/plugin.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-prism/prism-tomorrow.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-writeup-utils/plugin.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-search/search.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-fontsettings/website.css"rel="stylesheet"><meta content="true"name="HandheldFriendly"/><meta content="width=device-width,initial-scale=1,user-scalable=no"name="viewport"><meta content="yes"name="apple-mobile-web-app-capable"><meta content="black"name="apple-mobile-web-app-status-bar-style"><link href="../../../../../gitbook/images/apple-touch-icon-precomposed-152.png"rel="apple-touch-icon-precomposed"sizes="152x152"><link href="../../../../../gitbook/images/favicon.ico"rel="shortcut icon"type="image/x-icon"><link href="../sharky/"rel="next"/><link href="../yafm/"rel="prev"/></head><body><div class="book"><div class="book-summary"><nav role="navigation"><ul class="summary"><li class="chapter"data-level="1.1"data-path="../../../../../"><a href="../../../../../">Introduction</a></li><li class="header">Writeups</li><li class="header">2020</li><li class="chapter"data-level="3.1"><span>TWCTF</span><ul class="articles"><li class="chapter"data-level="3.1.1"data-path="../../../tokyoWesterns/rev/metal/"><a href="../../../tokyoWesterns/rev/metal/">rev - metal</a></li><li class="chapter"data-level="3.1.2"data-path="../../../tokyoWesterns/crypto/xs/"><a href="../../../tokyoWesterns/crypto/xs/">crypto - XOR and shift encryptor</a></li></ul></li><li class="chapter"data-level="3.2"><span>Google</span><ul class="articles"><li class="chapter"data-level="3.2.1"data-path="../oracle/"><a href="../oracle/">crypto - Oracle</a></li><li class="chapter"data-level="3.2.2"data-path="../yafm/"><a href="../yafm/">crypto - YAFM</a></li><li class="chapter active"data-level="3.2.3"data-path="./"><a href="./">crypto - Quantum Pyramids</a></li><li class="chapter"data-level="3.2.4"data-path="../sharky/"><a href="../sharky/">crypto - SHArky</a></li></ul></li><li class="header">2019</li><li class="chapter"data-level="4.1"><span>Google</span><ul class="articles"><li class="chapter"data-level="4.1.1"data-path="../../../../2019/google/crypto/reality/"><a href="../../../../2019/google/crypto/reality/">crypto - reality</a></li><li class="chapter"data-level="4.1.2"data-path="../../../../2019/google/crypto/qkd/"><a href="../../../../2019/google/crypto/qkd/">crypto - Quantum Key Distribution</a></li><li class="chapter"data-level="4.1.3"data-path="../../../../2019/google/crypto/cell/"><a href="../../../../2019/google/crypto/cell/">crypto - Reverse a cellular automata</a></li><li class="chapter"data-level="4.1.4"data-path="../../../../2019/google/hardware/flagrom/"><a href="../../../../2019/google/hardware/flagrom/">hardware - flagrom</a></li><li class="chapter"data-level="4.1.5"data-path="../../../../2019/google/hardware/minetest/"><a href="../../../../2019/google/hardware/minetest/">hardware - minetest</a></li><li class="chapter"data-level="4.1.6"data-path="../../../../2019/google/hardware/remote/"><a href="../../../../2019/google/hardware/remote/">hardware - Remote Control</a></li><li class="chapter"data-level="4.1.7"data-path="../../../../2019/google/web/glotto/"><a href="../../../../2019/google/web/glotto/">web - gLotto</a></li><li class="chapter"data-level="4.1.8"data-path="../../../../2019/google/rev/dial/"><a href="../../../../2019/google/rev/dial/">rev - Dialtone</a></li></ul></li><li class="chapter"data-level="4.2"><span>Plaid</span><ul class="articles"><li class="chapter"data-level="4.2.1"data-path="../../../../2019/plaid/crypto/cypress/"><a href="../../../../2019/plaid/crypto/cypress/">crypto - SPlaid Cypress</a></li><li class="chapter"data-level="4.2.2"data-path="../../../../2019/plaid/rev/bigmaffs/"><a href="../../../../2019/plaid/rev/bigmaffs/">rev - big maffs</a></li></ul></li><li class="header">2018</li><li class="chapter"data-level="5.1"><span>hxp</span><ul class="articles"><li class="chapter"data-level="5.1.1"data-path="../../../../2018/hxp/crypto/blinder_v2/"><a href="../../../../2018/hxp/crypto/blinder_v2/">crypto - blinder_v2</a></li><li class="chapter"data-level="5.1.2"data-path="../../../../2018/hxp/crypto/blinder/"><a href="../../../../2018/hxp/crypto/blinder/">crypto - blinder</a></li><li class="chapter"data-level="5.1.3"data-path="../../../../2018/hxp/crypto/curve/"><a href="../../../../2018/hxp/crypto/curve/">crypto - curve12833227</a></li><li class="chapter"data-level="5.1.4"data-path="../../../../2018/hxp/crypto/oops/"><a href="../../../../2018/hxp/crypto/oops/">crypto - oops2</a></li><li class="chapter"data-level="5.1.5"data-path="../../../../2018/hxp/crypto/blind/"><a href="../../../../2018/hxp/crypto/blind/">crypto - blind</a></li></ul></li><li class="chapter"data-level="5.2"><span>Pwn2Win</span><ul class="articles"><li class="chapter"data-level="5.2.1"data-path="../../../../2018/pwn2win/rev/back_to_bletchley_park/"><a href="../../../../2018/pwn2win/rev/back_to_bletchley_park/">cryrev - Back To Bletchley Park</a></li><li class="chapter"data-level="5.2.2"data-path="../../../../2018/pwn2win/crypto/GCM/"><a href="../../../../2018/pwn2win/crypto/GCM/">crypto - GCM</a></li></ul></li><li class="chapter"data-level="5.3"><span>HITCON</span><ul class="articles"><li class="chapter"data-level="5.3.1"data-path="../../../../2018/hitcon/crypto/lostmod/"><a href="../../../../2018/hitcon/crypto/lostmod/">crypto - Lost Modulus</a></li><li class="chapter"data-level="5.3.2"data-path="../../../../2018/hitcon/crypto/secret/"><a href="../../../../2018/hitcon/crypto/secret/">crypwn - Secret Note</a></li></ul></li><li class="chapter"data-level="5.4"><span>Hack.lu</span><ul class="articles"><li class="chapter"data-level="5.4.1"data-path="../../../../2018/Hack.lu/crypto/escape/"><a href="../../../../2018/Hack.lu/crypto/escape/">crypto - Escape the Grid</a></li><li class="chapter"data-level="5.4.2"data-path="../../../../2018/Hack.lu/crypto/relation/"><a href="../../../../2018/Hack.lu/crypto/relation/">crypto - Relations</a></li><li class="chapter"data-level="5.4.3"data-path="../../../../2018/Hack.lu/crypto/lfsr/"><a href="../../../../2018/Hack.lu/crypto/lfsr/">crypto - LFSR StreamCipher</a><ul class="articles"><li class="chapter"data-level="5.4.3.1"data-path="../../../../2018/Hack.lu/crypto/lfsr/task.html"><a href="../../../../2018/Hack.lu/crypto/lfsr/task.html">task description</a></li></ul></li></ul></li><li class="chapter"data-level="5.5"><span>Hackover</span><ul class="articles"><li class="chapter"data-level="5.5.1"data-path="../../../../2018/HackOver/crypto/oblivious/"><a href="../../../../2018/HackOver/crypto/oblivious/">crypto - oblivious</a></li><li class="chapter"data-level="5.5.2"data-path="../../../../2018/HackOver/crypto/secure_hash_v2/"><a href="../../../../2018/HackOver/crypto/secure_hash_v2/">crypto - secure_hash_v2</a></li><li class="chapter"data-level="5.5.3"data-path="../../../../2018/HackOver/rev/flagmaker/"><a href="../../../../2018/HackOver/rev/flagmaker/">rev - flagmaker</a></li></ul></li><li class="chapter"data-level="5.6"><span>Teaser Dragon</span><ul class="articles"><li class="chapter"data-level="5.6.1"data-path="../../../../2018/TeaserDragon/rev/Chains of trust/"><a href="../../../../2018/TeaserDragon/rev/Chains of trust/">rev - Chains of trust</a></li></ul></li><li class="chapter"data-level="5.7"><span>Defcamp</span><ul class="articles"><li class="chapter"data-level="5.7.1"data-path="../../../../2018/defcamp/rev/validator/"><a href="../../../../2018/defcamp/rev/validator/">rev - validator</a></li><li class="chapter"data-level="5.7.2"data-path="../../../../2018/defcamp/rev/memsome/"><a href="../../../../2018/defcamp/rev/memsome/">rev - memsome</a></li><li class="chapter"data-level="5.7.3"data-path="../../../../2018/defcamp/web/secops/"><a href="../../../../2018/defcamp/web/secops/">web - secops</a></li><li class="chapter"data-level="5.7.4"data-path="../../../../2018/defcamp/web/chat/"><a href="../../../../2018/defcamp/web/chat/">web - chat</a></li><li class="chapter"data-level="5.7.5"data-path="../../../../2018/defcamp/misc/voices/"><a href="../../../../2018/defcamp/misc/voices/">misc - voices</a></li></ul></li><li class="chapter"data-level="5.8"><span>HackIT</span><ul class="articles"><li class="chapter"data-level="5.8.1"data-path="../../../../2018/HackIT/coffee_overflow/"><a href="../../../../2018/HackIT/coffee_overflow/">rev - coffee_overflow</a></li></ul></li><li class="header">My Tasks</li><li class="header">2018</li><li class="chapter"data-level="7.1"><span>AIS3 Final</span><ul class="articles"><li class="chapter"data-level="7.1.1"data-path="../../../../../tasks/2018/ais3Final/crypto/100-mama/"><a href="../../../../../tasks/2018/ais3Final/crypto/100-mama/">crypto - mama</a></li><li class="chapter"data-level="7.1.2"data-path="../../../../../tasks/2018/ais3Final/crypto/200-secureSub/"><a href="../../../../../tasks/2018/ais3Final/crypto/200-secureSub/">crypto - secureSub</a></li><li class="chapter"data-level="7.1.3"data-path="../../../../../tasks/2018/ais3Final/crypto/300-xorlnarmoni'akda/"><a href="../../../../../tasks/2018/ais3Final/crypto/300-xorlnarmoni'akda/">crypto - xorlnarmoni'akda</a></li><li class="chapter"data-level="7.1.4"data-path="../../../../../tasks/2018/ais3Final/rev/100-SecDES/"><a href="../../../../../tasks/2018/ais3Final/rev/100-SecDES/">rev - SecDES</a></li><li class="chapter"data-level="7.1.5"data-path="../../../../../tasks/2018/ais3Final/rev/200-AlmightyDuctTape/"><a href="../../../../../tasks/2018/ais3Final/rev/200-AlmightyDuctTape/">rev - Almighty Duct Tape</a></li></ul></li><li class="header">2019</li><li class="chapter"data-level="8.1"><span>Balsn CTF</span><ul class="articles"><li class="chapter"data-level="8.1.1"data-path="../../../../../tasks/2019/BalsnCTF/"><a href="../../../../../tasks/2019/BalsnCTF/">Overview</a></li><li class="chapter"data-level="8.1.2"data-path="../../../../../tasks/2019/BalsnCTF/crypto/collision/"><a href="../../../../../tasks/2019/BalsnCTF/crypto/collision/">crypto - collision</a></li><li class="chapter"data-level="8.1.3"data-path="../../../../../tasks/2019/BalsnCTF/crypto/harc4/"><a href="../../../../../tasks/2019/BalsnCTF/crypto/harc4/">crypto - harc4</a></li><li class="chapter"data-level="8.1.4"data-path="../../../../../tasks/2019/BalsnCTF/crypto/unpredictable/"><a href="../../../../../tasks/2019/BalsnCTF/crypto/unpredictable/">crypto - unpredictable</a></li><li class="chapter"data-level="8.1.5"data-path="../../../../../tasks/2019/BalsnCTF/pwn/securenote/"><a href="../../../../../tasks/2019/BalsnCTF/pwn/securenote/">crypwn - securenote</a></li><li class="chapter"data-level="8.1.6"data-path="../../../../../tasks/2019/BalsnCTF/misc/pyshv1/"><a href="../../../../../tasks/2019/BalsnCTF/misc/pyshv1/">misc - pyshv1</a></li><li class="chapter"data-level="8.1.7"data-path="../../../../../tasks/2019/BalsnCTF/misc/pyshv2/"><a href="../../../../../tasks/2019/BalsnCTF/misc/pyshv2/">misc - pyshv2</a></li><li class="chapter"data-level="8.1.8"data-path="../../../../../tasks/2019/BalsnCTF/misc/pyshv3/"><a href="../../../../../tasks/2019/BalsnCTF/misc/pyshv3/">misc - pyshv3</a></li><li class="chapter"data-level="8.1.9"data-path="../../../../../tasks/2019/BalsnCTF/misc/john/"><a href="../../../../../tasks/2019/BalsnCTF/misc/john/">misc - john</a></li><li class="chapter"data-level="8.1.10"data-path="../../../../../tasks/2019/BalsnCTF/rev/plam/"><a href="../../../../../tasks/2019/BalsnCTF/rev/plam/">rev - plam</a></li><li class="chapter"data-level="8.1.11"data-path="../../../../../tasks/2019/BalsnCTF/rev/vim/"><a href="../../../../../tasks/2019/BalsnCTF/rev/vim/">rev - vim</a></li></ul></li><li class="header">2020</li><li class="chapter"data-level="9.1"><span>Balsn CTF</span><ul class="articles"><li class="chapter"data-level="9.1.1"data-path="../../../../../tasks/2020/BalsnCTF/crypto/aeshash/"><a href="../../../../../tasks/2020/BalsnCTF/crypto/aeshash/">crypto - aeshash</a></li></ul></li><li class="header">2021</li><li class="chapter"data-level="10.1"><span>ACSC</span><ul class="articles"><li class="chapter"data-level="10.1.1"data-path="../../../../../tasks/2021/ACSC/crypto/share_the_flag/"><a href="../../../../../tasks/2021/ACSC/crypto/share_the_flag/">crypto - Share The Flag</a></li></ul></li><li class="chapter"data-level="10.2"><span>Balsn CTF</span><ul class="articles"><li class="chapter"data-level="10.2.1"data-path="../../../../../tasks/2021/BalsnCTF/"><a href="../../../../../tasks/2021/BalsnCTF/">Overview</a></li><li class="chapter"data-level="10.2.2"data-path="../../../../../tasks/2021/BalsnCTF/crypto/1337pins/"><a href="../../../../../tasks/2021/BalsnCTF/crypto/1337pins/">crypto - 1337 pins</a></li><li class="chapter"data-level="10.2.3"data-path="../../../../../tasks/2021/BalsnCTF/crypto/dlog/"><a href="../../../../../tasks/2021/BalsnCTF/crypto/dlog/">crypto - dlog</a></li><li class="chapter"data-level="10.2.4"data-path="../../../../../tasks/2021/BalsnCTF/crypto/trinity/"><a href="../../../../../tasks/2021/BalsnCTF/crypto/trinity/">crypto - trinity</a></li></ul></li><li class="divider"></li><li><a href="https://www.gitbook.com"target="blank"class="gitbook-link">Published with GitBook</a></li></ul></nav></div><div class="book-body"><div class="body-inner"><div class="book-header"role="navigation"><h1><i class="fa fa-circle-o-notch fa-spin"></i> <a href="../../../../..">crypto - Quantum Pyramids</a></h1></div><div class="page-wrapper"role="main"tabindex="-1"><div class="page-inner"><section class="markdown-section normal"><div class="wpHeaderContainer"><h1 id="quantum-pyramids">Quantum Pyramids</h1><div><span><a href="https://github.com/sasdf/ctf/blob/master/writeup/2020/google/crypto/quantum"target="_blank"><img alt="Attachments"src="https://img.shields.io/badge/-Attachments-lightgrey.svg?style=for-the-badge&amp;maxAge=3600&amp;logo=github"></a></span><span><img alt="crypto - 373"src="https://img.shields.io/badge/crypto-373-green.svg?style=for-the-badge&amp;maxAge=3600"></span><span><img alt="9 solves"src="https://img.shields.io/badge/solves-9-lightseagreen.svg?style=for-the-badge&amp;maxAge=3600"></span></div></div><p></p><blockquote><p>A super efficient post-quantum signature scheme has been deployed. Can you forge a signature?</p></blockquote><h2 id="time">Time</h2><p>5 hours</p><h1 id="behavior">Behavior</h1><p>The attatchment is a zip of <a href="https://github.com/sphincs/sphincsplus"target="_blank">sphincsplus</a> repo.</p><blockquote><p>You are given access to a service, which allow you to obtain digital signatures for messages of your choice. The service uses SPHINCS+ with a custom set of highly efficient parameters, not even a quantum computer will help you to break it.</p><p>Your goal is to produce a valid signature for the message opensesame and send it to the /verify endpoint in order to get access to the secret flag.</p></blockquote><h1 id="solution">Solution</h1><h2 id="tldr">TL;DR</h2><ol><li>Collect some signatures until all secrets are revealed</li><li>Hook on the code of sphincs+ to build the full hash tree</li><li>Generate the signature with the hash tree</li></ol><h2 id="settings">Settings</h2><pre class="language-"><code>$ git status
On branch master
Your branch is behind &apos;origin/master&apos; by 47 commits, and can be fast-forwarded.
  (use &quot;git pull&quot; to update your local branch)

Revert currently in progress.
  (run &quot;git revert --continue&quot; to continue)
  (use &quot;git revert --skip&quot; to skip this patch)
  (use &quot;git revert --abort&quot; to cancel the revert operation)

Changes not staged for commit:
  (use &quot;git add <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>file</span><span class="token punctuation">&gt;</span></span>...&quot; to update what will be committed)
  (use &quot;git restore <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>file</span><span class="token punctuation">&gt;</span></span>...&quot; to discard changes in working directory)
        new file:   ref/params/params-sphincs-haraka-ctf2020.h

no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)
</code></pre><p>And the only changes is:</p><pre class="language-"><code class="lang-diff">$ diff ref/params/params-sphincs-haraka-ctf2020.h ref/params/params-sphincs-haraka-128f.h
<span class="token coord">5c5</span>
<span class="token deleted deleted-arrow"><span class="token prefix deleted">&lt;</span><span class="token line"> #define SPX_N 8
</span></span><span class="token coord">---</span>
<span class="token inserted inserted-arrow"><span class="token prefix inserted">&gt;</span><span class="token line"> #define SPX_N 16
</span></span><span class="token coord">7c7</span>
<span class="token deleted deleted-arrow"><span class="token prefix deleted">&lt;</span><span class="token line"> #define SPX_FULL_HEIGHT 4
</span></span><span class="token coord">---</span>
<span class="token inserted inserted-arrow"><span class="token prefix inserted">&gt;</span><span class="token line"> #define SPX_FULL_HEIGHT 60
</span></span><span class="token coord">9c9</span>
<span class="token deleted deleted-arrow"><span class="token prefix deleted">&lt;</span><span class="token line"> #define SPX_D 2
</span></span><span class="token coord">---</span>
<span class="token inserted inserted-arrow"><span class="token prefix inserted">&gt;</span><span class="token line"> #define SPX_D 20
</span></span><span class="token coord">11,12c11,12</span>
<span class="token deleted deleted-arrow"><span class="token prefix deleted">&lt;</span><span class="token line"> #define SPX_FORS_HEIGHT 6
</span><span class="token prefix deleted">&lt;</span><span class="token line"> #define SPX_FORS_TREES 17
</span></span><span class="token coord">---</span>
<span class="token inserted inserted-arrow"><span class="token prefix inserted">&gt;</span><span class="token line"> #define SPX_FORS_HEIGHT 9
</span><span class="token prefix inserted">&gt;</span><span class="token line"> #define SPX_FORS_TREES 30
</span></span></code></pre><p>Looks like they decrease the parameters a lot.</p><p>So, what is SPHINCS+ ?</p><h2 id="sphincs-and-hash-based-signatures">SPHINCS+ and hash-based signatures</h2><blockquote><p>SPHINCS+ is a stateless hash-based signature scheme, which was submitted to the NIST post-quantum crypto project. The design advances the SPHINCS signature scheme, which was presented at EUROCRYPT 2015. It incorporates multiple improvements, specifically aimed at reducing signature size.</p></blockquote><p>Basically, sphincs+ is a combination of many hash-based signature techniques to make it usable.</p><p>Hash-based signature is based on the assumption that given <code>H(x)</code>, it is hard to find <code>x</code>. The spirit is simple, use secret inputs as signature, and their hash is public key. All variants are just about the way of generating secret and the way of hashing.</p><p>For example, The simplest scheme (Lamport signature) for signing one bit looks like this:</p><ol><li>Generate two secret strings A, B as secret key</li><li>Publish H(A), H(B) as public key</li><li>If we are signing 0, the signature is A, otherwise B.</li></ol><p>Clearly, the secret can be used only once. After publish A, we should make sure that B should never become public.</p><p>In practice, we usually use hash tree (e.g. Merkle-tree) or hash chain (e.g. Winternitz ots). These details is not necessary for solving this challenge, but it is more easily to understand it with these knowledge. You could find some great explanation in these posts:</p><pre class="language-"><code>* https://sphincs.cr.yp.to/slides-sphincs-20150421.pdf
* https://huelsing.net/wordpress/wp-content/uploads/2016/02/20160223_pq_winter_school.pdf
* https://huelsing.net/wordpress/?p=558
</code></pre><p>In sphincs, they eliminate the state by using a hypertree which has a lot of leaves (i.e. secret inputs). We don&apos;t need to remember which secret is already used, the probability of reusing is just small enough to be ignored.</p><h2 id="solving-the-challenge">Solving the challenge</h2><p>BUT, notice that we have a special sphincs+ instances with a lot of parameters become very small.</p><p>I pulled about 10000 signatures from the server, and here&apos;s the count of unique values in each qwords:</p><pre class="language-"><code>idx: #uniq -     example      x cnt  
  0: 12772 - 2d853651495084b4 x 1    // Random key for hashing
  1:  1024 - 7e7585c57531d678 x 25   // FORS-1
  2:  1024 - 8d26227f72cc914b x 25   // FORS-1
  3:   512 - 27da1a6c634238c6 x 38   // FORS-1
  4:   256 - d32e9ea01783a3cc x 70   // FORS-1
  5:   128 - b39121da965bef8f x 125  // FORS-1
  6:    64 - 3d02b49eda59a150 x 235  // FORS-1
  7:    32 - fd9d015ab65900fd x 435  // FORS-1
  8:  1024 - bd1bd911f2f39cec x 26   // FORS-2
  9:  1024 - fa6ac0752e9cb731 x 26   // FORS-2
 10:   512 - 34e6bd54a770b469 x 42   // FORS-2
 11:   256 - 82651ba74dd9455c x 69   // FORS-2
 12:   128 - 158c3d25a24a02b8 x 128  // FORS-2
 13:    64 - 1a4ad7f8f0783719 x 232  // FORS-2
 14:    32 - 562329eccec33799 x 457  // FORS-2
 15:  1024 - d2b61dbb2daf5b49 x 23   // FORS-3
 16:  1024 - ac4b54d0c48276cc x 23   // FORS-3
 17:   512 - 683875de63b890a4 x 39   // FORS-3
 18:   256 - ddd93bcfd720b3a2 x 70   // FORS-3
 19:   128 - a041760993c0a32c x 124  // FORS-3
 20:    64 - 6462557963caaae8 x 228  // FORS-3
 21:    32 - 838ed3cfd29c542c x 434  // FORS-3
 22:  1024 - b41cf9a4c9ebcaec x 25   // FORS-4
 23:  1024 - 4895b0e833dcb3ba x 25   // FORS-4
 24:   512 - e460e9e2822c9a8b x 42   // FORS-4
 25:   256 - b0e3c052ec4b4733 x 72   // FORS-4
 26:   128 - 43e04ee4a70e017f x 124  // FORS-4
 27:    64 - 733a7c1469b550fa x 231  // FORS-4
 28:    32 - c24c722efa5a5b7f x 440  // FORS-4
 29:  1024 - 53916bedb9969899 x 25   // FORS-5
 30:  1024 - 349cd77029ce6c93 x 25   // FORS-5
 31:   512 - ad533a08f172b061 x 40   // FORS-5
 32:   256 - 1b1236e10ff354cb x 79   // FORS-5
 33:   128 - 7330eddf964c65c4 x 124  // FORS-5
 34:    64 - fad3f1375b44d129 x 233  // FORS-5
 35:    32 - 894f09dda8d41c83 x 438  // FORS-5
 36:  1024 - 257b3682f83700f0 x 26   // FORS-6
 37:  1024 - a5f83e3cc73082a6 x 26   // FORS-6
 38:   512 - 9603a086b9a56b2d x 41   // FORS-6
 39:   256 - 12d334597803b5fd x 74   // FORS-6
 40:   128 - d0419c4dd6c10f6d x 129  // FORS-6
 41:    64 - ae593d7d358363bd x 230  // FORS-6
 42:    32 - b9ef4c2308ddc235 x 433  // FORS-6
 43:  1024 - 2b0c4b6d49f3f071 x 27   // FORS-7
 44:  1024 - 7cc0ba2a1c2f7cae x 27   // FORS-7
 45:   512 - d03c25e0c4866988 x 46   // FORS-7
 46:   256 - 013a79d19bd341af x 76   // FORS-7
 47:   128 - ac2ea4824895c00c x 124  // FORS-7
 48:    64 - e232f877dee34d4f x 234  // FORS-7
 49:    32 - e838684115a2fdfd x 441  // FORS-7
 50:  1024 - a350886647d2bb7a x 24   // FORS-8
 51:  1024 - c5403169c0cedc57 x 24   // FORS-8
 52:   512 - 600ee241c95d86b8 x 38   // FORS-8
 53:   256 - 10fb53e0c5712372 x 68   // FORS-8
 54:   128 - 153a01c7da1eaed2 x 127  // FORS-8
 55:    64 - 71a59e74ee59ca96 x 225  // FORS-8
 56:    32 - a0bb0637bb628d0c x 437  // FORS-8
 57:  1024 - 9c955e74d15a9271 x 25   // FORS-9
 58:  1024 - 0cf47ef4802ff20c x 25   // FORS-9
 59:   512 - 639c4fea77c4ae08 x 45   // FORS-9
 60:   256 - 974947da86e06764 x 75   // FORS-9
 61:   128 - 395d3254b13300dd x 129  // FORS-9
 62:    64 - 1bb1e78fd6c745ab x 234  // FORS-9
 63:    32 - d28daa26b8f93d31 x 440  // FORS-9
 64:  1024 - c3d33b90ed3f4261 x 26   // FORS-10
 65:  1024 - c5d588fdd7ac241f x 26   // FORS-10
 66:   512 - 9f02a614c0333125 x 41   // FORS-10
 67:   256 - 52dd9ce0f515048c x 70   // FORS-10
 68:   128 - 3bea14cedfdbc377 x 136  // FORS-10
 69:    64 - c9cc2741e503dfe7 x 236  // FORS-10
 70:    32 - fa20723c1213f64d x 435  // FORS-10
 71:  1024 - 5a3fc193020948b2 x 25   // FORS-11
 72:  1024 - 11793b3477d2ba55 x 25   // FORS-11
 73:   512 - 6892969e91673ff6 x 40   // FORS-11
 74:   256 - 5d00330cc3277fba x 68   // FORS-11
 75:   128 - 2fde22ff6c903077 x 120  // FORS-11
 76:    64 - 53ec8779630ed300 x 227  // FORS-11
 77:    32 - 18c651049b988ebf x 454  // FORS-11
 78:  1024 - 4b997ebe9b956450 x 28   // FORS-12
 79:  1024 - 2585e0b777a2a027 x 28   // FORS-12
 80:   512 - 4ad993d5e0e9f289 x 40   // FORS-12
 81:   256 - a62796d7dac335d7 x 68   // FORS-12
 82:   128 - 1ebd59935972274c x 121  // FORS-12
 83:    64 - 1972d2a5eeedfca8 x 226  // FORS-12
 84:    32 - 3430a3f87ba5e2d1 x 435  // FORS-12
 85:  1024 - 23c4b9b48a5ea619 x 26   // FORS-13
 86:  1024 - 002623cb166d2f1a x 26   // FORS-13
 87:   512 - 591f8901a2500fda x 41   // FORS-13
 88:   256 - 7407d7a8b256c529 x 75   // FORS-13
 89:   128 - 92f805c6ec356348 x 125  // FORS-13
 90:    64 - 5a3b424062ece24b x 234  // FORS-13
 91:    32 - 8618a525eaafc6db x 439  // FORS-13
 92:  1024 - 0f662b03f2438cb0 x 24   // FORS-14
 93:  1024 - d9aef0dc2dc86728 x 24   // FORS-14
 94:   512 - e428f650d73dd171 x 42   // FORS-14
 95:   256 - 8a1802b636d97ee8 x 69   // FORS-14
 96:   128 - d896d78fa3b95b9c x 120  // FORS-14
 97:    64 - 66c3cf4775adc63c x 224  // FORS-14
 98:    32 - 25f9002bb6d74238 x 435  // FORS-14
 99:  1024 - 3897ad41884aff94 x 26   // FORS-15
100:  1024 - e9e909bbb895b49f x 26   // FORS-15
101:   512 - f11525c63d283d2d x 40   // FORS-15
102:   256 - 623c548f2d645896 x 73   // FORS-15
103:   128 - 1da0c2f11cf8c06c x 132  // FORS-15
104:    64 - 61bfe0c1e2a3df2f x 243  // FORS-15
105:    32 - e34b71c327b8dee3 x 441  // FORS-15
106:  1024 - b54d4040ef827aa5 x 26   // FORS-16
107:  1024 - 47492b0be2b69e67 x 26   // FORS-16
108:   512 - ef1693f20cf1f9f2 x 41   // FORS-16
109:   256 - 21a8c6feb971ebe4 x 71   // FORS-16
110:   128 - 55add77a56e283db x 131  // FORS-16
111:    64 - 4b0490eccab5003f x 240  // FORS-16
112:    32 - f59b4c9c8941830e x 433  // FORS-16
113:  1024 - af0c87dd0c99950c x 26   // FORS-17
114:  1024 - eac4c09b747aa013 x 26   // FORS-17
115:   512 - 67491f7392c76f73 x 41   // FORS-17
116:   256 - 2456c78dfa9402cf x 67   // FORS-17
117:   128 - 8d83a6fb5c98660b x 125  // FORS-17
118:    64 - 5f526edfb152bd09 x 225  // FORS-17
119:    32 - cc41df0e98c5c10f x 439  // FORS-17
120:    16 - 4d4acc3d1bb16e12 x 848  // WOTS
121:    16 - af97fbb0bce0cc32 x 848  // WOTS
122:    16 - 98e275e0d71c2777 x 848  // WOTS
123:    16 - 4fae664d1da13c70 x 848  // WOTS
124:    16 - 854bbecfb2064401 x 848  // WOTS
125:    16 - 6888ddf833bfe1e6 x 848  // WOTS
126:    16 - 054448ff9847ba1a x 848  // WOTS
127:    16 - b40a539f735444c2 x 848  // WOTS
128:    16 - dab57309507067a1 x 848  // WOTS
129:    16 - 82dbd184da82f3b6 x 848  // WOTS
130:    16 - f560dad64a766d6a x 848  // WOTS
131:    16 - 198d0d2b2659fc21 x 848  // WOTS
132:    16 - a59b0c82d444e2b3 x 848  // WOTS
133:    16 - 818e7d699419a31b x 848  // WOTS
134:    16 - cb88ef1012d68c53 x 848  // WOTS
135:    16 - c54d7c011dbc7dbd x 848  // WOTS
136:    16 - b569183e57239212 x 848  // WOTS
137:    16 - f438b1646efeba9e x 848  // WOTS
138:    16 - 7f9f2e96415b8fd0 x 848  // WOTS
139:     8 - 93dc80152c4b61bc x 1635 // WOTS
140:     4 - 3c5d48449c59b17f x 3229 // WOTS
141:     4 - 11935c93beccf89b x 3229 // WOTS
142:     4 - 6d02255e5fcdd972 x 3229 // WOTS
143:     4 - 736ff7d507243dc5 x 3229 // WOTS
144:     4 - b4de6e12321633bd x 3229 // WOTS
145:     4 - 2a6d7a360178a468 x 3229 // WOTS
146:     4 - 5625ce003a25875b x 3229 // WOTS
147:     4 - 234e0dedd8bf9a33 x 3229 // WOTS
148:     4 - 4fee4659cbc577ea x 3229 // WOTS
149:     4 - 1921f20b6e42ceb4 x 3229 // WOTS
150:     4 - c80af1fe32aea76d x 3229 // WOTS
151:     4 - 998dd80f2e0bf988 x 3229 // WOTS
152:     4 - f0e710e45429ae01 x 3229 // WOTS
153:     4 - 8930607dc9dc4058 x 3229 // WOTS
154:     4 - 2e346cb18267065f x 3229 // WOTS
155:     4 - dd68f2b3f7b30cc3 x 3229 // WOTS
156:     4 - 1b35da4cb4e89fc8 x 3229 // WOTS
157:     4 - 65706e33de120c8f x 3229 // WOTS
158:     4 - d9c3456528632d02 x 3229 // Merkle tree
159:     2 - 624299f44512271e x 6430 // Merkle tree
</code></pre><p>Great! It looks like that we have all the secret values.</p><p>Now, the problem is which value should we use for the signature given a input message.</p><p>The sphincs scheme is quite complex with a lot of details for building the tree, I&apos;m pretty sure I&apos;ll messup all the things if I implemented by myself at 4 am. So I decide to modify the code of signature verification instead. I modify all the places that will access the value of signature, and save the value to a table. Fortunately, the implementation in sphincsplus use a universal address for trees:</p><pre class="language-"><code class="lang-c"><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> SPX_FORS_TREES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    idx_offset <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> SPX_FORS_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">set_tree_height</span><span class="token punctuation">(</span>fors_tree_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_tree_index</span><span class="token punctuation">(</span>fors_tree_addr<span class="token punctuation">,</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> idx_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// My hook for saving/loading signatures to/from the database</span>
    <span class="token function">load_addr</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span> fors_tree_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Derive the leaf from the included secret key part. */</span>
    <span class="token function">fors_sk_to_leaf</span><span class="token punctuation">(</span>leaf<span class="token punctuation">,</span> sig<span class="token punctuation">,</span> pub_seed<span class="token punctuation">,</span> fors_tree_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sig <span class="token operator">+=</span> SPX_N<span class="token punctuation">;</span>

    <span class="token comment">/* Derive the corresponding root node of this tree. */</span>
    <span class="token function">compute_root</span><span class="token punctuation">(</span>roots <span class="token operator">+</span> i<span class="token operator">*</span>SPX_N<span class="token punctuation">,</span> leaf<span class="token punctuation">,</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> idx_offset<span class="token punctuation">,</span>
                 sig<span class="token punctuation">,</span> SPX_FORS_HEIGHT<span class="token punctuation">,</span> pub_seed<span class="token punctuation">,</span> fors_tree_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sig <span class="token operator">+=</span> SPX_N <span class="token operator">*</span> SPX_FORS_HEIGHT<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><code>sig</code> in a pointer to signature, and we can use <code>fors_tree_addr</code> as the index to save/load the values.</p><p>After hooking on all those signature accessing code, we&apos;re able to build the table by running &quot;verification&quot; function on all signatures we collected. And we can build the signature with &quot;verification&quot; function too. You can found those patched files at <a href="https://github.com/sasdf/ctf/blob/master/writeup/2020/google/crypto/quantum/_files/patches"target="_blank">here</a>.</p></section></div></div></div><a href="../yafm/"class="navigation navigation-prev"aria-label="Previous page: crypto - YAFM"><i class="fa fa-angle-left"></i> </a><a href="../sharky/"class="navigation navigation-next"aria-label="Next page: crypto - SHArky"><i class="fa fa-angle-right"></i></a></div><script>var gitbook=gitbook||[];gitbook.push(function(){gitbook.page.hasChanged({page:{name:"Quantum Pyramids",category:"crypto",points:373,solves:9,title:"crypto - Quantum Pyramids",level:"3.2.3",depth:2,next:{title:"crypto - SHArky",level:"3.2.4",depth:2,path:"writeup/2020/google/crypto/sharky/README.md",ref:"writeup/2020/google/crypto/sharky/README.md",articles:[]},previous:{title:"crypto - YAFM",level:"3.2.2",depth:2,path:"writeup/2020/google/crypto/yafm/README.md",ref:"writeup/2020/google/crypto/yafm/README.md",articles:[]},dir:"ltr"},config:{gitbook:"*",theme:"default",variables:{},plugins:["katex@git://github.com/sasdf/plugin-katex.git","disqus","prism","-highlight","html-minifier","writeup-utils@git://github.com/sasdf/gitbook-plugin-writeup-utils.git"],pluginsConfig:{prism:{css:["prismjs/themes/prism-tomorrow.css"],lang:{C:"c","C++":"cpp",asm:"nasm"}},disqus:{useIdentifier:!1,shortName:"sasdfwriteup"},search:{maxIndexSize:1e6},"html-minifier":{customAttrSurround:[],removeScriptTypeAttributes:!1,removeEmptyAttributes:!1,removeRedundantAttributes:!1,removeEmptyElements:!1,sortClassName:!0,caseSensitive:!0,html5:!0,collapseWhitespace:!0,processConditionalComments:!1,quoteCharacter:null,keepClosingSlash:!0,preventAttributesEscaping:!1,minifyURLs:!1,removeAttributeQuotes:!1,decodeEntities:!1,trimCustomFragments:!1,customAttrAssign:[],includeAutoGeneratedTags:!0,collapseInlineTagWhitespace:!1,collapseBooleanAttributes:!0,minifyJS:!0,removeTagWhitespace:!0,preserveLineBreaks:!1,sortAttributes:!0,removeStyleLinkTypeAttributes:!1,removeComments:!0,minifyCSS:!0,processScripts:[],conservativeCollapse:!1,removeOptionalTags:!1,useShortDoctype:!1},lunr:{maxIndexSize:1e6,ignoreSpecialCharacters:!1},katex:{},fontsettings:{theme:"white",family:"sans",size:2},sharing:{facebook:!0,twitter:!0,google:!1,weibo:!1,instapaper:!1,vk:!1,all:["facebook","google","twitter","weibo","instapaper"]},"theme-default":{styles:{website:"styles/website.css",pdf:"styles/pdf.css",epub:"styles/epub.css",mobi:"styles/mobi.css",ebook:"styles/ebook.css",print:"styles/print.css"},showLevel:!1},"writeup-utils":{filePrefix:"https://github.com/sasdf/ctf/blob/master",repoPrefix:"https://github.com/sasdf/ctf/blob/master",rawPrefix:"https://raw.githubusercontent.com/sasdf/ctf/master"}},structure:{langs:"LANGS.md",readme:"README.md",glossary:"GLOSSARY.md",summary:"SUMMARY.md"},pdf:{pageNumbers:!0,fontSize:12,fontFamily:"Arial",paperSize:"a4",chapterMark:"pagebreak",pageBreaksBefore:"/",margin:{right:62,left:62,top:56,bottom:56}},styles:{website:"styles/website.css",pdf:"styles/pdf.css",epub:"styles/epub.css",mobi:"styles/mobi.css",ebook:"styles/ebook.css",print:"styles/print.css"}},file:{path:"writeup/2020/google/crypto/quantum/README.md",mtime:"2021-11-23T11:07:12.664Z",type:"markdown"},gitbook:{version:"3.2.3",time:"2021-11-25T02:55:11.093Z"},basePath:"../../../../..",book:{language:""}})})</script></div><script src="../../../../../gitbook/gitbook.js"></script><script src="../../../../../gitbook/theme.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script><script src="../../../../../gitbook/gitbook-plugin-disqus/plugin.js"></script><script src="../../../../../gitbook/gitbook-plugin-search/lunr.min.js"></script><script src="../../../../../gitbook/gitbook-plugin-search/search.js"></script><script src="../../../../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script><script src="../../../../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script><script src="../../../../../gitbook/gitbook-plugin-sharing/buttons.js"></script><script src="../../../../../gitbook/gitbook-plugin-fontsettings/buttons.js"></script></body></html>