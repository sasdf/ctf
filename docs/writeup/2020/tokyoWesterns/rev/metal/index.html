<!DOCTYPE HTML><html lang=""><head><meta charset="UTF-8"><meta content="text/html; charset=utf-8"http-equiv="Content-Type"><title>rev - metal Â· GitBook</title><meta content="IE=edge"http-equiv="X-UA-Compatible"/><meta content=""name="description"><meta content="GitBook 3.2.3"name="generator"><link href="../../../../../gitbook/style.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-katex/katex.min.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-disqus/plugin.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-prism/prism-tomorrow.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-writeup-utils/plugin.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-search/search.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-fontsettings/website.css"rel="stylesheet"><meta content="true"name="HandheldFriendly"/><meta content="width=device-width,initial-scale=1,user-scalable=no"name="viewport"><meta content="yes"name="apple-mobile-web-app-capable"><meta content="black"name="apple-mobile-web-app-status-bar-style"><link href="../../../../../gitbook/images/apple-touch-icon-precomposed-152.png"rel="apple-touch-icon-precomposed"sizes="152x152"><link href="../../../../../gitbook/images/favicon.ico"rel="shortcut icon"type="image/x-icon"><link href="../../crypto/xs/"rel="next"/></head><body><div class="book"><div class="book-summary"><nav role="navigation"><ul class="summary"><li class="chapter"data-level="1.1"data-path="../../../../../"><a href="../../../../../">Introduction</a></li><li class="header">Writeups</li><li class="header">2020</li><li class="chapter"data-level="3.1"><span>TWCTF</span><ul class="articles"><li class="chapter active"data-level="3.1.1"data-path="./"><a href="./">rev - metal</a></li><li class="chapter"data-level="3.1.2"data-path="../../crypto/xs/"><a href="../../crypto/xs/">crypto - XOR and shift encryptor</a></li></ul></li><li class="chapter"data-level="3.2"><span>Google</span><ul class="articles"><li class="chapter"data-level="3.2.1"data-path="../../../google/crypto/oracle/"><a href="../../../google/crypto/oracle/">crypto - Oracle</a></li><li class="chapter"data-level="3.2.2"data-path="../../../google/crypto/yafm/"><a href="../../../google/crypto/yafm/">crypto - YAFM</a></li><li class="chapter"data-level="3.2.3"data-path="../../../google/crypto/quantum/"><a href="../../../google/crypto/quantum/">crypto - Quantum Pyramids</a></li><li class="chapter"data-level="3.2.4"data-path="../../../google/crypto/sharky/"><a href="../../../google/crypto/sharky/">crypto - SHArky</a></li></ul></li><li class="header">2019</li><li class="chapter"data-level="4.1"><span>Google</span><ul class="articles"><li class="chapter"data-level="4.1.1"data-path="../../../../2019/google/crypto/reality/"><a href="../../../../2019/google/crypto/reality/">crypto - reality</a></li><li class="chapter"data-level="4.1.2"data-path="../../../../2019/google/crypto/qkd/"><a href="../../../../2019/google/crypto/qkd/">crypto - Quantum Key Distribution</a></li><li class="chapter"data-level="4.1.3"data-path="../../../../2019/google/crypto/cell/"><a href="../../../../2019/google/crypto/cell/">crypto - Reverse a cellular automata</a></li><li class="chapter"data-level="4.1.4"data-path="../../../../2019/google/hardware/flagrom/"><a href="../../../../2019/google/hardware/flagrom/">hardware - flagrom</a></li><li class="chapter"data-level="4.1.5"data-path="../../../../2019/google/hardware/minetest/"><a href="../../../../2019/google/hardware/minetest/">hardware - minetest</a></li><li class="chapter"data-level="4.1.6"data-path="../../../../2019/google/hardware/remote/"><a href="../../../../2019/google/hardware/remote/">hardware - Remote Control</a></li><li class="chapter"data-level="4.1.7"data-path="../../../../2019/google/web/glotto/"><a href="../../../../2019/google/web/glotto/">web - gLotto</a></li><li class="chapter"data-level="4.1.8"data-path="../../../../2019/google/rev/dial/"><a href="../../../../2019/google/rev/dial/">rev - Dialtone</a></li></ul></li><li class="chapter"data-level="4.2"><span>Plaid</span><ul class="articles"><li class="chapter"data-level="4.2.1"data-path="../../../../2019/plaid/crypto/cypress/"><a href="../../../../2019/plaid/crypto/cypress/">crypto - SPlaid Cypress</a></li><li class="chapter"data-level="4.2.2"data-path="../../../../2019/plaid/rev/bigmaffs/"><a href="../../../../2019/plaid/rev/bigmaffs/">rev - big maffs</a></li></ul></li><li class="header">2018</li><li class="chapter"data-level="5.1"><span>hxp</span><ul class="articles"><li class="chapter"data-level="5.1.1"data-path="../../../../2018/hxp/crypto/blinder_v2/"><a href="../../../../2018/hxp/crypto/blinder_v2/">crypto - blinder_v2</a></li><li class="chapter"data-level="5.1.2"data-path="../../../../2018/hxp/crypto/blinder/"><a href="../../../../2018/hxp/crypto/blinder/">crypto - blinder</a></li><li class="chapter"data-level="5.1.3"data-path="../../../../2018/hxp/crypto/curve/"><a href="../../../../2018/hxp/crypto/curve/">crypto - curve12833227</a></li><li class="chapter"data-level="5.1.4"data-path="../../../../2018/hxp/crypto/oops/"><a href="../../../../2018/hxp/crypto/oops/">crypto - oops2</a></li><li class="chapter"data-level="5.1.5"data-path="../../../../2018/hxp/crypto/blind/"><a href="../../../../2018/hxp/crypto/blind/">crypto - blind</a></li></ul></li><li class="chapter"data-level="5.2"><span>Pwn2Win</span><ul class="articles"><li class="chapter"data-level="5.2.1"data-path="../../../../2018/pwn2win/rev/back_to_bletchley_park/"><a href="../../../../2018/pwn2win/rev/back_to_bletchley_park/">cryrev - Back To Bletchley Park</a></li><li class="chapter"data-level="5.2.2"data-path="../../../../2018/pwn2win/crypto/GCM/"><a href="../../../../2018/pwn2win/crypto/GCM/">crypto - GCM</a></li></ul></li><li class="chapter"data-level="5.3"><span>HITCON</span><ul class="articles"><li class="chapter"data-level="5.3.1"data-path="../../../../2018/hitcon/crypto/lostmod/"><a href="../../../../2018/hitcon/crypto/lostmod/">crypto - Lost Modulus</a></li><li class="chapter"data-level="5.3.2"data-path="../../../../2018/hitcon/crypto/secret/"><a href="../../../../2018/hitcon/crypto/secret/">crypwn - Secret Note</a></li></ul></li><li class="chapter"data-level="5.4"><span>Hack.lu</span><ul class="articles"><li class="chapter"data-level="5.4.1"data-path="../../../../2018/Hack.lu/crypto/escape/"><a href="../../../../2018/Hack.lu/crypto/escape/">crypto - Escape the Grid</a></li><li class="chapter"data-level="5.4.2"data-path="../../../../2018/Hack.lu/crypto/relation/"><a href="../../../../2018/Hack.lu/crypto/relation/">crypto - Relations</a></li><li class="chapter"data-level="5.4.3"data-path="../../../../2018/Hack.lu/crypto/lfsr/"><a href="../../../../2018/Hack.lu/crypto/lfsr/">crypto - LFSR StreamCipher</a><ul class="articles"><li class="chapter"data-level="5.4.3.1"data-path="../../../../2018/Hack.lu/crypto/lfsr/task.html"><a href="../../../../2018/Hack.lu/crypto/lfsr/task.html">task description</a></li></ul></li></ul></li><li class="chapter"data-level="5.5"><span>Hackover</span><ul class="articles"><li class="chapter"data-level="5.5.1"data-path="../../../../2018/HackOver/crypto/oblivious/"><a href="../../../../2018/HackOver/crypto/oblivious/">crypto - oblivious</a></li><li class="chapter"data-level="5.5.2"data-path="../../../../2018/HackOver/crypto/secure_hash_v2/"><a href="../../../../2018/HackOver/crypto/secure_hash_v2/">crypto - secure_hash_v2</a></li><li class="chapter"data-level="5.5.3"data-path="../../../../2018/HackOver/rev/flagmaker/"><a href="../../../../2018/HackOver/rev/flagmaker/">rev - flagmaker</a></li></ul></li><li class="chapter"data-level="5.6"><span>Teaser Dragon</span><ul class="articles"><li class="chapter"data-level="5.6.1"data-path="../../../../2018/TeaserDragon/rev/Chains of trust/"><a href="../../../../2018/TeaserDragon/rev/Chains of trust/">rev - Chains of trust</a></li></ul></li><li class="chapter"data-level="5.7"><span>Defcamp</span><ul class="articles"><li class="chapter"data-level="5.7.1"data-path="../../../../2018/defcamp/rev/validator/"><a href="../../../../2018/defcamp/rev/validator/">rev - validator</a></li><li class="chapter"data-level="5.7.2"data-path="../../../../2018/defcamp/rev/memsome/"><a href="../../../../2018/defcamp/rev/memsome/">rev - memsome</a></li><li class="chapter"data-level="5.7.3"data-path="../../../../2018/defcamp/web/secops/"><a href="../../../../2018/defcamp/web/secops/">web - secops</a></li><li class="chapter"data-level="5.7.4"data-path="../../../../2018/defcamp/web/chat/"><a href="../../../../2018/defcamp/web/chat/">web - chat</a></li><li class="chapter"data-level="5.7.5"data-path="../../../../2018/defcamp/misc/voices/"><a href="../../../../2018/defcamp/misc/voices/">misc - voices</a></li></ul></li><li class="chapter"data-level="5.8"><span>HackIT</span><ul class="articles"><li class="chapter"data-level="5.8.1"data-path="../../../../2018/HackIT/coffee_overflow/"><a href="../../../../2018/HackIT/coffee_overflow/">rev - coffee_overflow</a></li></ul></li><li class="header">My Tasks</li><li class="header">2018</li><li class="chapter"data-level="7.1"><span>AIS3 Final</span><ul class="articles"><li class="chapter"data-level="7.1.1"data-path="../../../../../tasks/2018/ais3Final/crypto/100-mama/"><a href="../../../../../tasks/2018/ais3Final/crypto/100-mama/">crypto - mama</a></li><li class="chapter"data-level="7.1.2"data-path="../../../../../tasks/2018/ais3Final/crypto/200-secureSub/"><a href="../../../../../tasks/2018/ais3Final/crypto/200-secureSub/">crypto - secureSub</a></li><li class="chapter"data-level="7.1.3"data-path="../../../../../tasks/2018/ais3Final/crypto/300-xorlnarmoni'akda/"><a href="../../../../../tasks/2018/ais3Final/crypto/300-xorlnarmoni'akda/">crypto - xorlnarmoni'akda</a></li><li class="chapter"data-level="7.1.4"data-path="../../../../../tasks/2018/ais3Final/rev/100-SecDES/"><a href="../../../../../tasks/2018/ais3Final/rev/100-SecDES/">rev - SecDES</a></li><li class="chapter"data-level="7.1.5"data-path="../../../../../tasks/2018/ais3Final/rev/200-AlmightyDuctTape/"><a href="../../../../../tasks/2018/ais3Final/rev/200-AlmightyDuctTape/">rev - Almighty Duct Tape</a></li></ul></li><li class="header">2019</li><li class="chapter"data-level="8.1"><span>Balsn CTF</span><ul class="articles"><li class="chapter"data-level="8.1.1"data-path="../../../../../tasks/2019/BalsnCTF/"><a href="../../../../../tasks/2019/BalsnCTF/">Overview</a></li><li class="chapter"data-level="8.1.2"data-path="../../../../../tasks/2019/BalsnCTF/crypto/collision/"><a href="../../../../../tasks/2019/BalsnCTF/crypto/collision/">crypto - collision</a></li><li class="chapter"data-level="8.1.3"data-path="../../../../../tasks/2019/BalsnCTF/crypto/harc4/"><a href="../../../../../tasks/2019/BalsnCTF/crypto/harc4/">crypto - harc4</a></li><li class="chapter"data-level="8.1.4"data-path="../../../../../tasks/2019/BalsnCTF/crypto/unpredictable/"><a href="../../../../../tasks/2019/BalsnCTF/crypto/unpredictable/">crypto - unpredictable</a></li><li class="chapter"data-level="8.1.5"data-path="../../../../../tasks/2019/BalsnCTF/pwn/securenote/"><a href="../../../../../tasks/2019/BalsnCTF/pwn/securenote/">crypwn - securenote</a></li><li class="chapter"data-level="8.1.6"data-path="../../../../../tasks/2019/BalsnCTF/misc/pyshv1/"><a href="../../../../../tasks/2019/BalsnCTF/misc/pyshv1/">misc - pyshv1</a></li><li class="chapter"data-level="8.1.7"data-path="../../../../../tasks/2019/BalsnCTF/misc/pyshv2/"><a href="../../../../../tasks/2019/BalsnCTF/misc/pyshv2/">misc - pyshv2</a></li><li class="chapter"data-level="8.1.8"data-path="../../../../../tasks/2019/BalsnCTF/misc/pyshv3/"><a href="../../../../../tasks/2019/BalsnCTF/misc/pyshv3/">misc - pyshv3</a></li><li class="chapter"data-level="8.1.9"data-path="../../../../../tasks/2019/BalsnCTF/misc/john/"><a href="../../../../../tasks/2019/BalsnCTF/misc/john/">misc - john</a></li><li class="chapter"data-level="8.1.10"data-path="../../../../../tasks/2019/BalsnCTF/rev/plam/"><a href="../../../../../tasks/2019/BalsnCTF/rev/plam/">rev - plam</a></li><li class="chapter"data-level="8.1.11"data-path="../../../../../tasks/2019/BalsnCTF/rev/vim/"><a href="../../../../../tasks/2019/BalsnCTF/rev/vim/">rev - vim</a></li></ul></li><li class="divider"></li><li><a href="https://www.gitbook.com"target="blank"class="gitbook-link">Published with GitBook</a></li></ul></nav></div><div class="book-body"><div class="body-inner"><div class="book-header"role="navigation"><h1><i class="fa fa-circle-o-notch fa-spin"></i> <a href="../../../../..">rev - metal</a></h1></div><div class="page-wrapper"role="main"tabindex="-1"><div class="page-inner"><section class="markdown-section normal"><div class="wpHeaderContainer"><h1 id="metal">metal</h1><div><span><a href="https://github.com/sasdf/ctf/blob/master/writeup/2020/tokyoWesterns/rev/metal"target="_blank"><img alt="Attachments"src="https://img.shields.io/badge/-Attachments-lightgrey.svg?style=for-the-badge&amp;maxAge=3600&amp;logo=github"></a></span><span><img alt="rev - 500"src="https://img.shields.io/badge/rev-500-green.svg?style=for-the-badge&amp;maxAge=3600"></span><span><img alt="1 solves"src="https://img.shields.io/badge/solves-1-lightseagreen.svg?style=for-the-badge&amp;maxAge=3600"></span></div></div><p></p><h2 id="time">Time</h2><p>20 hours</p><h1 id="behavior">Behavior</h1><p>We got a C++ program that somehow encrypt the flag. There are two files called &quot;hw_x64.metal&quot; and &quot;metal_genx.isa&quot;.</p><h1 id="solution">Solution</h1><h2 id="tldr">TL;DR</h2><ol><li>Disassemble the cisa binary file to visa asm.</li><li>Cleanup the syntax.</li><li>Manually decompiled it to pseudo code.</li><li>Construct the eigenvector (i.e. key) from eigenvalues.</li></ol><h2 id="host-executable">Host Executable</h2><p>The main executable &quot;hw_x64.metal&quot; is unstripped. It won&apos;t be too hard to understand.</p><p>Searching for the library/strings on the Internet, we can figure out that it is using Intel&apos;s C for Metal (i.e. GPGPU). And here&apos;s a <a href="https://01.org/c-for-metal-development-package/blogs/huangli/2019/basic-host-programming"target="_blank">sample code</a> that looks similar to our main executable.</p><p>The executable will load the flag and key, encrypt it with the GPU kernel (<code>metal_genx.isa</code>), and save the output from GPU to a file.</p><p>All encryption logics in the GPU kernel.</p><h2 id="disassemble">Disassemble</h2><p>To understand the GPU kernel, we need to find the definition of its ISA. We found <a href="https://github.com/intel/intel-graphics-compiler/blob/master/visa/Common_ISA.cpp"target="_blank">this file in intel-graphics-compiler</a> on GitHub. There are <a href="https://github.com/intel/intel-graphics-compiler/blob/master/documentation/visa/index.md"target="_blank">documentations of ISA</a> and a disassembler (!!!) in the same repo.</p><p>The repo is hard to compile. Luckily, we have pre-compiled version on Ubuntu 20.04. Spin up a VM and run the following code will give us visa asm file.</p><pre class="language-"><code class="lang-bash"><span class="token comment"># ubuntu 20.04</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libigc-tools
GenX_IR metal_genx.isa -dumpcommonisa
</code></pre><p>Now, time for reversing :)</p><h2 id="virtual-isa-of-metal">Virtual ISA of Metal</h2><p>The assembly code looks like:</p><pre class="language-"><code class="lang-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span>decl V32 v_type<span class="token operator">=</span>G <span class="token builtin">type</span><span class="token operator">=</span>uw num_elts<span class="token operator">=</span><span class="token number">1</span> align<span class="token operator">=</span>word
<span class="token punctuation">.</span>decl V33 v_type<span class="token operator">=</span>G <span class="token builtin">type</span><span class="token operator">=</span>d num_elts<span class="token operator">=</span><span class="token number">1</span> align<span class="token operator">=</span>dword
<span class="token punctuation">.</span>decl V34 v_type<span class="token operator">=</span>G <span class="token builtin">type</span><span class="token operator">=</span>df num_elts<span class="token operator">=</span><span class="token number">64</span> align<span class="token operator">=</span>GRF
<span class="token punctuation">.</span>decl V35 v_type<span class="token operator">=</span>G <span class="token builtin">type</span><span class="token operator">=</span>d num_elts<span class="token operator">=</span><span class="token number">1</span> align<span class="token operator">=</span>dword
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span>decl V297 v_type<span class="token operator">=</span>G <span class="token builtin">type</span><span class="token operator">=</span>ud num_elts<span class="token operator">=</span><span class="token number">1</span> align<span class="token operator">=</span>dword alias<span class="token operator">=</span><span class="token operator">&lt;</span>V37<span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">&gt;</span>
<span class="token punctuation">.</span>decl V298 v_type<span class="token operator">=</span>G <span class="token builtin">type</span><span class="token operator">=</span>w num_elts<span class="token operator">=</span><span class="token number">2</span> align<span class="token operator">=</span>dword alias<span class="token operator">=</span><span class="token operator">&lt;</span>V35<span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">&gt;</span>
<span class="token punctuation">.</span>decl V299 v_type<span class="token operator">=</span>G <span class="token builtin">type</span><span class="token operator">=</span>w num_elts<span class="token operator">=</span><span class="token number">2</span> align<span class="token operator">=</span>dword alias<span class="token operator">=</span><span class="token operator">&lt;</span>V41<span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">&gt;</span>
<span class="token punctuation">.</span>decl V300 v_type<span class="token operator">=</span>G <span class="token builtin">type</span><span class="token operator">=</span>uw num_elts<span class="token operator">=</span><span class="token number">1</span> align<span class="token operator">=</span>word alias<span class="token operator">=</span><span class="token operator">&lt;</span>V42<span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">&gt;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span>function <span class="token string">&quot;encrypt_BB_0_1_0&quot;</span>

encrypt_BB_0_1_0<span class="token punctuation">:</span>
    mov <span class="token punctuation">(</span>M1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> V32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span> V2<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">&gt;</span>                                       <span class="token operator">//</span><span class="token operator">/</span> $<span class="token number">1</span>
    mov <span class="token punctuation">(</span>M1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> V33<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span> V32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">&gt;</span>                                      <span class="token operator">//</span><span class="token operator">/</span> $<span class="token number">2</span>
    mov <span class="token punctuation">(</span>M1<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> V34<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token number">0x0</span><span class="token punctuation">:</span>df                                               <span class="token operator">//</span><span class="token operator">/</span> $<span class="token number">3</span>
    mov <span class="token punctuation">(</span>M1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> V146<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span> V33<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">&gt;</span>                                     <span class="token operator">//</span><span class="token operator">/</span> $<span class="token number">4</span>
    call <span class="token punctuation">(</span>M1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> _Z13getDataMatrixIdEv15cm_surfaceindexiu2CMmr8x8_T__BB_1_2_1    <span class="token operator">//</span><span class="token operator">/</span> $<span class="token number">5</span>
    mov <span class="token punctuation">(</span>M1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> V35<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token number">0x0</span><span class="token punctuation">:</span>d                                                <span class="token operator">//</span><span class="token operator">/</span> $<span class="token number">6</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
BB_5_6<span class="token punctuation">:</span>
    mov <span class="token punctuation">(</span>M1<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> V50<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span> V6<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">&gt;</span>                                       <span class="token operator">//</span><span class="token operator">/</span> $<span class="token number">38</span>
    add <span class="token punctuation">(</span>M1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> V303<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span> V45<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">)</span>V50<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">&gt;</span>                  <span class="token operator">//</span><span class="token operator">/</span> $<span class="token number">39</span>
    <span class="token builtin">cmp</span><span class="token punctuation">.</span>lt <span class="token punctuation">(</span>M1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> P4 V51<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">&gt;</span> <span class="token number">0x0</span><span class="token punctuation">:</span>b                                      <span class="token operator">//</span><span class="token operator">/</span> $<span class="token number">40</span>
    <span class="token punctuation">(</span>P4<span class="token punctuation">)</span> jmp <span class="token punctuation">(</span>M1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> BB_6_7                                                      <span class="token operator">//</span><span class="token operator">/</span> $<span class="token number">41</span>
    mov <span class="token punctuation">(</span>M1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> V52<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token number">0x8</span><span class="token punctuation">:</span>w                                                <span class="token operator">//</span><span class="token operator">/</span> $<span class="token number">42</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><p>The syntax contains too much information, and too hard to read. Take the first instruction as an example,</p><pre class="language-"><code>mov       (M1,      1       )
mnemonic  exec_mask exec_size

V32  (0,        0        ) &lt;1&gt;
dst  row_offset col_offset stride

V2   (0,        0        ) &lt;0;             1,    0               &gt;
src0 row_offset col_offset vertical_stride width horizontal_stride
</code></pre><p>The semantics of <code>mov</code> instruction is:</p><pre class="language-"><code class="lang-c"><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">&lt;</span> exec_size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ChEn<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// i.e. exec_mask</span>
        dst<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> src0<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// with type conversion</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>A lot of the instruction in metal is SIMD operation. It operates on multiple data with one instruction.</p><p>The exec_mask in this task is always <code>M1</code>, which means no masking. So we can ignore the branch on <code>ChEn</code>.</p><p>All the variables in metal are arrays, and we have various way to access the values in these array.</p><p>The offsets in the parenthesis specified how many bytes we want to skip in front of the array. The byte offset defined as:</p><pre class="language-"><code class="lang-c"><span class="token number">32</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token operator">*</span> row_offset <span class="token operator">+</span> col_offset
</code></pre><p>In destination variable, <code>stride</code> indicate how many elements we should skip to move to the next element.</p><p>Using python&apos;s syntax, it is:</p><pre class="language-"><code class="lang-python">dst<span class="token punctuation">[</span>offset<span class="token punctuation">:</span><span class="token punctuation">:</span>stride<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span>exec_size<span class="token punctuation">]</span>
</code></pre><p>Source variable is more complicated.</p><p>After applying the byte offset, we reshape the remaining array as a matrix.</p><ul><li><code>width</code> is the width of the matrix.</li><li><code>horizontal_stride</code> indicate how many elements we should skip to move to the next element in the same row.</li><li><code>vertical_stride</code> indicate how many elements we should skip to move to the next row.</li></ul><p>And then we flatten the matrix back to a 1D array. For example, <code>(M1, 8) V0&lt;0, 2, 0&gt;</code> means <code>[[V0[0]] * 2] * 4</code>.</p><p>Fortunately, there are only 7 kind of different indices in this task:</p><pre class="language-"><code>Scalar:               0;1,0
Pointer Array:        1,0
Row vector:           1;1,0
One column of Pairs:  2;1,0
arr[:]:               1
arr[::8]:             8
arr[::16]:            16
</code></pre><p>Most of the variables in this task is scalar, we converted the syntax to numpy-like to make it more readable.</p><pre class="language-"><code class="lang-python"><span class="token punctuation">.</span>function <span class="token string">&quot;encrypt_BB_0_1_0&quot;</span>

encrypt_BB_0_1_0<span class="token punctuation">:</span>
    mov<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>               V32<span class="token punctuation">:</span>uw               thread_y<span class="token punctuation">:</span>G          
    mov<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>               V33<span class="token punctuation">:</span>d                V32<span class="token punctuation">:</span>uw              
    mov<span class="token operator">&lt;</span><span class="token number">8</span><span class="token operator">&gt;</span>               V34<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>df           <span class="token number">0x0</span><span class="token punctuation">:</span>df              
    mov<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>               V146<span class="token punctuation">:</span>d               V33<span class="token punctuation">:</span>d               
    call<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>              _Z13getDataMatrixIdEv15cm_surfaceindexiu2CMmr8x8_T__BB_1_2_1
    mov<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>               V35<span class="token punctuation">:</span>d                <span class="token number">0x0</span><span class="token punctuation">:</span>d               
    lifetime<span class="token punctuation">.</span>start       V58                 
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    mov<span class="token operator">&lt;</span><span class="token number">8</span><span class="token operator">&gt;</span>               V287<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>df          V58<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>df          
    mov<span class="token operator">&lt;</span><span class="token number">8</span><span class="token operator">&gt;</span>               V287<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>df          V58<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>df          
    mov<span class="token operator">&lt;</span><span class="token number">8</span><span class="token operator">&gt;</span>               V287<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>df         V58<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>df         
    mov<span class="token operator">&lt;</span><span class="token number">8</span><span class="token operator">&gt;</span>               V287<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>df         V58<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>df         
    mov<span class="token operator">&lt;</span><span class="token number">8</span><span class="token operator">&gt;</span>               V287<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>df         V58<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>df
</code></pre><p>In the second part of variable definition, there are some variable aliases:</p><pre class="language-"><code class="lang-python"><span class="token punctuation">.</span>decl V37 v_type<span class="token operator">=</span>G <span class="token builtin">type</span><span class="token operator">=</span>d num_elts<span class="token operator">=</span><span class="token number">1</span> align<span class="token operator">=</span>dword
<span class="token punctuation">.</span>decl V35 v_type<span class="token operator">=</span>G <span class="token builtin">type</span><span class="token operator">=</span>d num_elts<span class="token operator">=</span><span class="token number">1</span> align<span class="token operator">=</span>dword
<span class="token punctuation">.</span>decl V297 v_type<span class="token operator">=</span>G <span class="token builtin">type</span><span class="token operator">=</span>ud num_elts<span class="token operator">=</span><span class="token number">1</span> align<span class="token operator">=</span>dword alias<span class="token operator">=</span><span class="token operator">&lt;</span>V37<span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">&gt;</span>
<span class="token punctuation">.</span>decl V298 v_type<span class="token operator">=</span>G <span class="token builtin">type</span><span class="token operator">=</span>w num_elts<span class="token operator">=</span><span class="token number">2</span> align<span class="token operator">=</span>dword alias<span class="token operator">=</span><span class="token operator">&lt;</span>V35<span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">&gt;</span>
</code></pre><p>It is for type conversion, And we replace all those aliases with Go-like syntax.</p><pre class="language-"><code>    shr&lt;1&gt;               V38:ud               V37.(ud[1]):ud       0x4:ud
</code></pre><p>Branches are implemented by conditional instructions:</p><pre class="language-"><code class="lang-python">    <span class="token builtin">cmp</span><span class="token punctuation">.</span>eq <span class="token punctuation">(</span>M1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> P8 V61<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">&gt;</span> <span class="token number">0x8</span><span class="token punctuation">:</span>d                                      <span class="token operator">//</span><span class="token operator">/</span> $<span class="token number">83</span>
    <span class="token punctuation">(</span>!P8<span class="token punctuation">)</span> jmp <span class="token punctuation">(</span>M1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> BB_10_11                                                   <span class="token operator">//</span><span class="token operator">/</span> $<span class="token number">84</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token builtin">cmp</span><span class="token punctuation">.</span>gt <span class="token punctuation">(</span>M1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> P39 V174<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">&gt;</span> V168<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">&gt;</span>                         <span class="token operator">//</span><span class="token operator">/</span> $<span class="token number">434</span>
    <span class="token punctuation">(</span>P39<span class="token punctuation">)</span> sel <span class="token punctuation">(</span>M1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> V69<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span> r<span class="token punctuation">[</span>A43<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>d V69<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">&gt;</span>           <span class="token operator">//</span><span class="token operator">/</span> $<span class="token number">435</span>
    <span class="token punctuation">(</span>P39<span class="token punctuation">)</span> sel <span class="token punctuation">(</span>M1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> V70<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span> V169<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">&gt;</span> V70<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">&gt;</span>               <span class="token operator">//</span><span class="token operator">/</span> $<span class="token number">436</span>
</code></pre><p>There are also pointer/address types in this language:</p><pre class="language-"><code class="lang-python">    shl<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>               V42<span class="token punctuation">:</span>w                V41<span class="token punctuation">.</span><span class="token punctuation">(</span>w<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>w      <span class="token number">0x3</span><span class="token punctuation">:</span>w               
    addr_add<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>          A0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>A            <span class="token operator">&amp;</span>V39<span class="token operator">+</span><span class="token number">0</span>               V42<span class="token punctuation">.</span><span class="token punctuation">(</span>uw<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>uw      
    mov<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>               V43<span class="token punctuation">:</span>df               A0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>uq
</code></pre><p>This snippet is equivalent to <code>V43 = V39[V41]</code>. Note that <code>addr_add</code> works on byte offset, so there are <code>shl 3</code> multiplying the element size. (V39 is unsigned qword array)</p><p>Full script can be found at <a href="https://github.com/sasdf/ctf/blob/master/writeup/2020/tokyoWesterns/rev/metal/_files/cleanup.py"target="_blank">here</a>.</p><h2 id="decompile">Decompile</h2><p>With the simplified assembly, we manually translate it into python-like pseudo code.</p><pre class="language-"><code class="lang-python">     <span class="token operator">//</span> v58 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">64</span>
     lifetime<span class="token punctuation">.</span>start       V58
 BB_2_3<span class="token punctuation">:</span>
     <span class="token operator">//</span> <span class="token keyword">for</span> v35 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
         <span class="token operator">//</span> v38 <span class="token operator">=</span> thread_y <span class="token operator">*</span> <span class="token number">32</span> <span class="token operator">+</span> v35 <span class="token operator">*</span> <span class="token number">4</span>
         <span class="token operator">//</span> v38p <span class="token operator">=</span> thread_y <span class="token operator">*</span> <span class="token number">64</span> <span class="token operator">+</span> v35 <span class="token operator">*</span> <span class="token number">8</span>
         shl<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>               V36<span class="token punctuation">:</span>d                V35<span class="token punctuation">:</span>d                <span class="token number">0x6</span><span class="token punctuation">:</span>d
         mov<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>               V37<span class="token punctuation">:</span>d                <span class="token number">0x200</span><span class="token punctuation">:</span>d
         mad<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>               V37<span class="token punctuation">:</span>d                V32<span class="token punctuation">:</span>uw               V37<span class="token punctuation">:</span>d                V36<span class="token punctuation">:</span>d
         shr<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>               V38<span class="token punctuation">:</span>ud               V37<span class="token punctuation">.</span><span class="token punctuation">(</span>ud<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>ud       <span class="token number">0x4</span><span class="token punctuation">:</span>ud
         <span class="token operator">//</span> v39 <span class="token operator">=</span> inp_t6<span class="token punctuation">[</span>v38p<span class="token punctuation">:</span>v38p<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">]</span>
         oword_ld             <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>                  T6                   V38<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">&gt;</span>      V39<span class="token punctuation">.</span><span class="token number">0</span>
         <span class="token operator">//</span> v40 <span class="token operator">=</span> v35 <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">8</span>
         shl<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>               V40<span class="token punctuation">:</span>w                V35<span class="token punctuation">.</span><span class="token punctuation">(</span>w<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>w      <span class="token number">0x6</span><span class="token punctuation">:</span>w
         mov<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>               V41<span class="token punctuation">:</span>d                <span class="token number">0x0</span><span class="token punctuation">:</span>d
 BB_3_4<span class="token punctuation">:</span>
         <span class="token operator">//</span> <span class="token keyword">for</span> v41 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
             <span class="token operator">//</span> v43 <span class="token operator">=</span> v39<span class="token punctuation">[</span>v41<span class="token punctuation">]</span>
             shl<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>               V42<span class="token punctuation">:</span>w                V41<span class="token punctuation">.</span><span class="token punctuation">(</span>w<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>w      <span class="token number">0x3</span><span class="token punctuation">:</span>w
             addr_add<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>          A0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>A            <span class="token operator">&amp;</span>V39<span class="token operator">+</span><span class="token number">0</span>               V42<span class="token punctuation">.</span><span class="token punctuation">(</span>uw<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>uw
             mov<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>               V43<span class="token punctuation">:</span>df               A0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>uq
</code></pre><p>This process might be simplified by some pattern matchings / symbolic engines, but we doing it manually, taking about 12 hours...</p><p>In this ISA, there&apos;s no predefined register set, and no calling convention. the argument and return value are implemented using global variable:</p><pre class="language-"><code class="lang-python"><span class="token operator">//</span> <span class="token comment"># V285 is the argument, and V286 is the return value.</span>
<span class="token operator">//</span> v67<span class="token punctuation">[</span>v70<span class="token punctuation">]</span> <span class="token operator">=</span> func_v287_tri_argmax<span class="token punctuation">(</span>v70<span class="token punctuation">)</span>
mov<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>               V285<span class="token punctuation">:</span>d               V70<span class="token punctuation">:</span>d
call<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>              func_v287_tri_argmax
shl<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>               V126<span class="token punctuation">:</span>w               V70<span class="token punctuation">.</span><span class="token punctuation">(</span>w<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>w      <span class="token number">0x2</span><span class="token punctuation">:</span>w
addr_add<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>          A30<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>A           <span class="token operator">&amp;</span>V67<span class="token operator">+</span><span class="token number">0</span>               V126<span class="token punctuation">.</span><span class="token punctuation">(</span>uw<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>uw
mov<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>               A30<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>d         V286<span class="token punctuation">:</span>d
</code></pre><p>The variable can be found around the caller, and the free variables in the function.</p><p>Here is the <a href="https://github.com/sasdf/ctf/blob/master/writeup/2020/tokyoWesterns/rev/metal/_files/annotated.asm]"target="_blank">annotated asm</a> and its <a href="[_files/pseudo.py">translated pseudo code</a></p><h2 id="algorithm">Algorithm</h2><p>The last function is find the position of maximum element in column v285 in upper triangular part of v287 key matrix.</p><pre class="language-"><code class="lang-python"><span class="token comment"># _Z16aAqwvgDTmHcpllEMIdEiu2CMmr8x8_T_i_BB_14_15_14:</span>
<span class="token keyword">def</span> <span class="token function">func_v287_tri_argmax</span><span class="token punctuation">(</span>v285<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># global v287</span>
    v286 <span class="token operator">=</span> v285 <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token keyword">if</span> v285 <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> v289 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>v285 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            v292 <span class="token operator">=</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>v287<span class="token punctuation">[</span>v285 <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> v289<span class="token punctuation">]</span><span class="token punctuation">)</span>
            v295 <span class="token operator">=</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>v287<span class="token punctuation">[</span>v285 <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> v286<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> v292 <span class="token operator">&gt;</span> v295<span class="token punctuation">:</span>
                v286 <span class="token operator">=</span> v289
    <span class="token keyword">return</span> v286
</code></pre><p>And the result is cached in v67.</p><pre class="language-"><code class="lang-python"><span class="token comment"># After modified v287</span>
v287<span class="token punctuation">[</span>i66<span class="token punctuation">]</span> <span class="token operator">=</span> v287<span class="token punctuation">[</span>i66<span class="token punctuation">]</span> <span class="token operator">*</span> v190 <span class="token operator">+</span> v242

<span class="token comment"># We should update v67</span>
a67v <span class="token operator">=</span> v67<span class="token punctuation">[</span>v239<span class="token punctuation">]</span>
<span class="token keyword">if</span> a67v <span class="token operator">!=</span> v189<span class="token punctuation">:</span>
    v248 <span class="token operator">=</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>v287<span class="token punctuation">[</span>i66<span class="token punctuation">]</span><span class="token punctuation">)</span>
    v251 <span class="token operator">=</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>v287<span class="token punctuation">[</span>v239 <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> a67v<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> v248 <span class="token operator">&gt;</span> v251<span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    v286 <span class="token operator">=</span> v189
<span class="token keyword">else</span><span class="token punctuation">:</span>
    v286 <span class="token operator">=</span> func_v287_tri_argmax<span class="token punctuation">(</span>v239<span class="token punctuation">)</span>
v67<span class="token punctuation">[</span>v239<span class="token punctuation">]</span> <span class="token operator">=</span> v286
</code></pre><p>And this function is finding maximum element in upper triangle using v67 caches.</p><pre class="language-"><code class="lang-python"><span class="token comment"># _Z16JPYgRtzJnMjnpuDbIdEvu2CMmr8x8_T_RiS2__BB_16_17_16:</span>
<span class="token keyword">def</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># global v67, v287</span>
    v69 <span class="token operator">=</span> v67<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    v167 <span class="token operator">=</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>v287<span class="token punctuation">[</span>v67<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    v168 <span class="token operator">=</span> v167
    v70 <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> v169 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

        v174 <span class="token operator">=</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>v287<span class="token punctuation">[</span>v169 <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> v67<span class="token punctuation">[</span>v169<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> v174 <span class="token operator">&gt;</span> v168<span class="token punctuation">:</span>
            v69 <span class="token operator">=</span> v67<span class="token punctuation">[</span>v169<span class="token punctuation">]</span>
            v70 <span class="token operator">=</span> v169

        v168 <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>v174<span class="token punctuation">,</span> v168<span class="token punctuation">)</span>

    <span class="token keyword">return</span> v69<span class="token punctuation">,</span> v70
</code></pre><p>The cache makes the code looks more complicated than it should be, Actually, we can remove those parts and calculate full argmax without cache.</p><p>There are also some functions inlined in main function, We move those function out to simplify main function.</p><p>Finally, we convert the it to runnable python code which can be found <a href="https://github.com/sasdf/ctf/blob/master/writeup/2020/tokyoWesterns/rev/metal/_files/decompiled.py"target="_blank">here</a>.</p><p>The main function looks like:</p><pre class="language-"><code class="lang-python"><span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>inp_key_t6<span class="token punctuation">,</span> inp_data_t8<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data_v34 <span class="token operator">=</span> func_getDataMatrix<span class="token punctuation">(</span>inp_data_t8<span class="token punctuation">,</span> thread_y<span class="token punctuation">)</span>

    <span class="token keyword">assert</span> inp_key_t6<span class="token punctuation">.</span>dtype <span class="token operator">==</span> np<span class="token punctuation">.</span>uint64
    mat_org_v58 <span class="token operator">=</span> inp_key_t6<span class="token punctuation">[</span>thread_y <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>double<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>
    mat_org_v58 <span class="token operator">*=</span> <span class="token number">2.0</span><span class="token operator">**</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token comment"># set m[i,j] = m[j,i] or m[j,i] = m[i,j] according to tsc</span>
    mat_org_v58 <span class="token operator">=</span> maybe_to_random_symmetric<span class="token punctuation">(</span>mat_org_v58<span class="token punctuation">)</span>

    out_v66 <span class="token operator">=</span> np<span class="token punctuation">.</span>eye<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>double<span class="token punctuation">)</span> <span class="token comment"># diagonal_mat8x8</span>

    mat <span class="token operator">=</span> mat_org_v58<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x800</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        mc<span class="token punctuation">,</span> mr <span class="token operator">=</span> func_upper_tri_abs_argmax<span class="token punctuation">(</span>mat<span class="token punctuation">)</span>

        <span class="token keyword">if</span> too_small_cf_diag<span class="token punctuation">(</span>mat<span class="token punctuation">,</span> mr<span class="token punctuation">,</span> mc<span class="token punctuation">)</span><span class="token punctuation">:</span>
            mat<span class="token punctuation">[</span>mr<span class="token punctuation">,</span>mc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>

        c3<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2 <span class="token operator">=</span> func_get_wtf_coeffs<span class="token punctuation">(</span>mat<span class="token punctuation">,</span> mr<span class="token punctuation">,</span> mc<span class="token punctuation">)</span>
        mat <span class="token operator">=</span> func_mix_matrix<span class="token punctuation">(</span>mat<span class="token punctuation">,</span> mr<span class="token punctuation">,</span> mc<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">)</span>
        out_v66 <span class="token operator">=</span> func_mix_row<span class="token punctuation">(</span>out_v66<span class="token punctuation">,</span> mr<span class="token punctuation">,</span> mc<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span>

    <span class="token comment"># get diagonal array, first 8 elements</span>
    diag_elems_v87 <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span>
    diag_elems_v87<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>diag<span class="token punctuation">(</span>mat<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span>

    <span class="token comment"># latter 8 * 7 = 56 elements</span>
    <span class="token keyword">for</span> r <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        mat <span class="token operator">=</span> remove_col_and_row<span class="token punctuation">(</span>mat_org_v58<span class="token punctuation">,</span> r<span class="token punctuation">)</span>

        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x800</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            mc<span class="token punctuation">,</span> mr <span class="token operator">=</span> func_upper_tri_abs_argmax<span class="token punctuation">(</span>mat<span class="token punctuation">)</span>

            <span class="token comment"># whether adding m[mr,mc] to m[mr,mr] and m[mc,mc] won&apos;t change its value</span>
            <span class="token comment"># (i.e. m[r,c] + m[r,r] == m[r,r] and m[r,c] + m[c,c] == m[c,c])</span>
            <span class="token keyword">if</span> too_small_cf_diag<span class="token punctuation">(</span>mat<span class="token punctuation">,</span> mr<span class="token punctuation">,</span> mc<span class="token punctuation">)</span><span class="token punctuation">:</span>
                mat<span class="token punctuation">[</span>mr<span class="token punctuation">,</span>mc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>

            c3<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2 <span class="token operator">=</span> func_get_wtf_coeffs<span class="token punctuation">(</span>mat<span class="token punctuation">,</span> mr<span class="token punctuation">,</span> mc<span class="token punctuation">)</span>
            mat <span class="token operator">=</span> func_mix_matrix<span class="token punctuation">(</span>mat<span class="token punctuation">,</span> mr<span class="token punctuation">,</span> mc<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">)</span>

        diag_elems_v87<span class="token punctuation">[</span>r <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>diag<span class="token punctuation">(</span>mat<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span>

    out_v66 <span class="token operator">=</span> data_v34 <span class="token operator">*</span> np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>out_v66<span class="token punctuation">)</span>

    <span class="token keyword">return</span> diag_elems_v87<span class="token punctuation">.</span>tobytes<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> out_v66<span class="token punctuation">.</span>tobytes<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p>The function will do the following things:</p><ol><li>Reshape the key to a 8x8 matrix</li><li>Shrink its value range to [0, 1].</li><li>Generate two matrix <code>mat</code> and <code>out_v66</code> from the key.</li><li><code>out_v66</code> is the key for encrypting flag.</li><li>We also got diagonal of the <code>mat</code> and 8 sub matrixes.</li></ol><p>I was trying to understand wtf is those mix functions first, but failed.</p><p>Then I increased 0x800 to 0x1000. Found that the result has already converged and didn&apos;t change. It looks like some numerical method, but it didn&apos;t help.</p><p>Last, I print out the <code>mat</code> and <code>out_v66</code>. The <code>mat</code> is almost a diagonal matrix, and <code>out_v66</code> is something looks random.</p><p>The previous CTF I played is p4ctf, and they have some challenges about diagonalization. It makes me tried the equation:</p><pre class="language-"><code class="lang-python">out_v66<span class="token punctuation">.</span>T @ np<span class="token punctuation">.</span>diag<span class="token punctuation">(</span>np<span class="token punctuation">.</span>diag<span class="token punctuation">(</span>mat<span class="token punctuation">)</span><span class="token punctuation">)</span> @ out_v66 <span class="token operator">~</span><span class="token operator">=</span> mat_org_v58
</code></pre><p>Bingo! The loop is calculating SVD.</p><p>It means we have several eigenvalues and we need to found its eigenvectors.</p><p>There was a paper quite famous in last year called <a href="https://arxiv.org/abs/1908.03795"target="_blank">Eigenvectors from Eigenvalues</a>. And the only equation we need is in its abstract.</p><p>For numerical stability, I calculate it in log domain. Also don&apos;t forget to use <code>round</code> instead of <code>floor</code>.</p><p><a href="https://github.com/sasdf/ctf/blob/master/writeup/2020/tokyoWesterns/rev/metal/_files/solve.py"target="_blank">Here</a> is the decryption script.</p></section></div></div></div><a href="../../crypto/xs/"class="navigation navigation-next navigation-unique"aria-label="Next page: crypto - XOR and shift encryptor"><i class="fa fa-angle-right"></i></a></div><script>var gitbook=gitbook||[];gitbook.push(function(){gitbook.page.hasChanged({page:{name:"metal",category:"rev",points:500,solves:1,title:"rev - metal",level:"3.1.1",depth:2,next:{title:"crypto - XOR and shift encryptor",level:"3.1.2",depth:2,path:"writeup/2020/tokyoWesterns/crypto/xs/README.md",ref:"writeup/2020/tokyoWesterns/crypto/xs/README.md",articles:[]},previous:{title:"TWCTF",level:"3.1",depth:1,ref:"",articles:[{title:"rev - metal",level:"3.1.1",depth:2,path:"writeup/2020/tokyoWesterns/rev/metal/README.md",ref:"writeup/2020/tokyoWesterns/rev/metal/README.md",articles:[]},{title:"crypto - XOR and shift encryptor",level:"3.1.2",depth:2,path:"writeup/2020/tokyoWesterns/crypto/xs/README.md",ref:"writeup/2020/tokyoWesterns/crypto/xs/README.md",articles:[]}]},dir:"ltr"},config:{gitbook:"*",theme:"default",variables:{},plugins:["katex@git://github.com/sasdf/plugin-katex.git","disqus","prism","-highlight","html-minifier","writeup-utils@git://github.com/sasdf/gitbook-plugin-writeup-utils.git"],pluginsConfig:{prism:{css:["prismjs/themes/prism-tomorrow.css"],lang:{C:"c","C++":"cpp",asm:"nasm"}},disqus:{useIdentifier:!1,shortName:"sasdfwriteup"},search:{maxIndexSize:1e6},"html-minifier":{customAttrSurround:[],removeScriptTypeAttributes:!1,removeEmptyAttributes:!1,removeRedundantAttributes:!1,removeEmptyElements:!1,sortClassName:!0,caseSensitive:!0,html5:!0,collapseWhitespace:!0,processConditionalComments:!1,quoteCharacter:null,keepClosingSlash:!0,preventAttributesEscaping:!1,minifyURLs:!1,removeAttributeQuotes:!1,decodeEntities:!1,trimCustomFragments:!1,customAttrAssign:[],includeAutoGeneratedTags:!0,collapseInlineTagWhitespace:!1,collapseBooleanAttributes:!0,minifyJS:!0,removeTagWhitespace:!0,preserveLineBreaks:!1,sortAttributes:!0,removeStyleLinkTypeAttributes:!1,removeComments:!0,minifyCSS:!0,processScripts:[],conservativeCollapse:!1,removeOptionalTags:!1,useShortDoctype:!1},lunr:{maxIndexSize:1e6,ignoreSpecialCharacters:!1},katex:{},fontsettings:{theme:"white",family:"sans",size:2},sharing:{facebook:!0,twitter:!0,google:!1,weibo:!1,instapaper:!1,vk:!1,all:["facebook","google","twitter","weibo","instapaper"]},"theme-default":{styles:{website:"styles/website.css",pdf:"styles/pdf.css",epub:"styles/epub.css",mobi:"styles/mobi.css",ebook:"styles/ebook.css",print:"styles/print.css"},showLevel:!1},"writeup-utils":{filePrefix:"https://github.com/sasdf/ctf/blob/master",repoPrefix:"https://github.com/sasdf/ctf/blob/master",rawPrefix:"https://raw.githubusercontent.com/sasdf/ctf/master"}},structure:{langs:"LANGS.md",readme:"README.md",glossary:"GLOSSARY.md",summary:"SUMMARY.md"},pdf:{pageNumbers:!0,fontSize:12,fontFamily:"Arial",paperSize:"a4",chapterMark:"pagebreak",pageBreaksBefore:"/",margin:{right:62,left:62,top:56,bottom:56}},styles:{website:"styles/website.css",pdf:"styles/pdf.css",epub:"styles/epub.css",mobi:"styles/mobi.css",ebook:"styles/ebook.css",print:"styles/print.css"}},file:{path:"writeup/2020/tokyoWesterns/rev/metal/README.md",mtime:"2020-09-25T17:26:19.486Z",type:"markdown"},gitbook:{version:"3.2.3",time:"2020-09-25T17:26:22.339Z"},basePath:"../../../../..",book:{language:""}})})</script></div><script src="../../../../../gitbook/gitbook.js"></script><script src="../../../../../gitbook/theme.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script><script src="../../../../../gitbook/gitbook-plugin-disqus/plugin.js"></script><script src="../../../../../gitbook/gitbook-plugin-search/lunr.min.js"></script><script src="../../../../../gitbook/gitbook-plugin-search/search.js"></script><script src="../../../../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script><script src="../../../../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script><script src="../../../../../gitbook/gitbook-plugin-sharing/buttons.js"></script><script src="../../../../../gitbook/gitbook-plugin-fontsettings/buttons.js"></script></body></html>