<!DOCTYPE HTML><html lang=""><head><meta charset="UTF-8"><meta content="text/html; charset=utf-8"http-equiv="Content-Type"><title>rev - coffee_overflow Â· GitBook</title><meta content="IE=edge"http-equiv="X-UA-Compatible"/><meta content=""name="description"><meta content="GitBook 3.2.3"name="generator"><link href="../../../../gitbook/style.css"rel="stylesheet"><link href="../../../../gitbook/gitbook-plugin-katex/katex.min.css"rel="stylesheet"><link href="../../../../gitbook/gitbook-plugin-disqus/plugin.css"rel="stylesheet"><link href="../../../../gitbook/gitbook-plugin-prism/prism-tomorrow.css"rel="stylesheet"><link href="../../../../gitbook/gitbook-plugin-writeup-utils/plugin.css"rel="stylesheet"><link href="../../../../gitbook/gitbook-plugin-search/search.css"rel="stylesheet"><link href="../../../../gitbook/gitbook-plugin-fontsettings/website.css"rel="stylesheet"><meta content="true"name="HandheldFriendly"/><meta content="width=device-width,initial-scale=1,user-scalable=no"name="viewport"><meta content="yes"name="apple-mobile-web-app-capable"><meta content="black"name="apple-mobile-web-app-status-bar-style"><link href="../../../../gitbook/images/apple-touch-icon-precomposed-152.png"rel="apple-touch-icon-precomposed"sizes="152x152"><link href="../../../../gitbook/images/favicon.ico"rel="shortcut icon"type="image/x-icon"></head><body><div class="book"><div class="book-summary"><div role="search"id="book-search-input"><input placeholder="Type to search"type="text"/></div><nav role="navigation"><ul class="summary"><li class="chapter"data-level="1.1"data-path="../../../../"><a href="../../../../">Introduction</a></li><li class="header">Writeups</li><li class="header">2019</li><li class="chapter"data-level="3.1"><span>Plaid</span><ul class="articles"><li class="chapter"data-level="3.1.1"data-path="../../../2019/plaid/crypto/cypress/"><a href="../../../2019/plaid/crypto/cypress/">crypto - SPlaid Cypress</a></li><li class="chapter"data-level="3.1.2"data-path="../../../2019/plaid/rev/bigmaffs/"><a href="../../../2019/plaid/rev/bigmaffs/">rev - big maffs</a></li></ul></li><li class="header">2018</li><li class="chapter"data-level="4.1"><span>hxp</span><ul class="articles"><li class="chapter"data-level="4.1.1"data-path="../../hxp/crypto/blinder_v2/"><a href="../../hxp/crypto/blinder_v2/">crypto - blinder_v2</a></li><li class="chapter"data-level="4.1.2"data-path="../../hxp/crypto/blinder/"><a href="../../hxp/crypto/blinder/">crypto - blinder</a></li><li class="chapter"data-level="4.1.3"data-path="../../hxp/crypto/curve/"><a href="../../hxp/crypto/curve/">crypto - curve12833227</a></li><li class="chapter"data-level="4.1.4"data-path="../../hxp/crypto/oops/"><a href="../../hxp/crypto/oops/">crypto - oops2</a></li><li class="chapter"data-level="4.1.5"data-path="../../hxp/crypto/blind/"><a href="../../hxp/crypto/blind/">crypto - blind</a></li></ul></li><li class="chapter"data-level="4.2"><span>Pwn2Win</span><ul class="articles"><li class="chapter"data-level="4.2.1"data-path="../../pwn2win/rev/back_to_bletchley_park/"><a href="../../pwn2win/rev/back_to_bletchley_park/">cryrev - Back To Bletchley Park</a></li><li class="chapter"data-level="4.2.2"data-path="../../pwn2win/crypto/GCM/"><a href="../../pwn2win/crypto/GCM/">crypto - GCM</a></li></ul></li><li class="chapter"data-level="4.3"><span>HITCON</span><ul class="articles"><li class="chapter"data-level="4.3.1"data-path="../../hitcon/crypto/lostmod/"><a href="../../hitcon/crypto/lostmod/">crypto - Lost Modulus</a></li><li class="chapter"data-level="4.3.2"data-path="../../hitcon/crypto/secret/"><a href="../../hitcon/crypto/secret/">crypwn - Secret Note</a></li></ul></li><li class="chapter"data-level="4.4"><span>Hack.lu</span><ul class="articles"><li class="chapter"data-level="4.4.1"data-path="../../Hack.lu/crypto/escape/"><a href="../../Hack.lu/crypto/escape/">crypto - Escape the Grid</a></li><li class="chapter"data-level="4.4.2"data-path="../../Hack.lu/crypto/relation/"><a href="../../Hack.lu/crypto/relation/">crypto - Relations</a></li><li class="chapter"data-level="4.4.3"data-path="../../Hack.lu/crypto/lfsr/"><a href="../../Hack.lu/crypto/lfsr/">crypto - LFSR StreamCipher</a><ul class="articles"><li class="chapter"data-level="4.4.3.1"data-path="../../Hack.lu/crypto/lfsr/task.html"><a href="../../Hack.lu/crypto/lfsr/task.html">task description</a></li></ul></li></ul></li><li class="chapter"data-level="4.5"><span>Hackover</span><ul class="articles"><li class="chapter"data-level="4.5.1"data-path="../../HackOver/crypto/oblivious/"><a href="../../HackOver/crypto/oblivious/">crypto - oblivious</a></li><li class="chapter"data-level="4.5.2"data-path="../../HackOver/crypto/secure_hash_v2/"><a href="../../HackOver/crypto/secure_hash_v2/">crypto - secure_hash_v2</a></li><li class="chapter"data-level="4.5.3"data-path="../../HackOver/rev/flagmaker/"><a href="../../HackOver/rev/flagmaker/">rev - flagmaker</a></li></ul></li><li class="chapter"data-level="4.6"><span>Teaser Dragon</span><ul class="articles"><li class="chapter"data-level="4.6.1"data-path="../../TeaserDragon/rev/Chains of trust/"><a href="../../TeaserDragon/rev/Chains of trust/">rev - Chains of trust</a></li></ul></li><li class="chapter"data-level="4.7"><span>Defcamp</span><ul class="articles"><li class="chapter"data-level="4.7.1"data-path="../../defcamp/rev/validator/"><a href="../../defcamp/rev/validator/">rev - validator</a></li><li class="chapter"data-level="4.7.2"data-path="../../defcamp/rev/memsome/"><a href="../../defcamp/rev/memsome/">rev - memsome</a></li><li class="chapter"data-level="4.7.3"data-path="../../defcamp/web/secops/"><a href="../../defcamp/web/secops/">web - secops</a></li><li class="chapter"data-level="4.7.4"data-path="../../defcamp/web/chat/"><a href="../../defcamp/web/chat/">web - chat</a></li><li class="chapter"data-level="4.7.5"data-path="../../defcamp/misc/voices/"><a href="../../defcamp/misc/voices/">misc - voices</a></li></ul></li><li class="chapter"data-level="4.8"><span>HackIT</span><ul class="articles"><li class="chapter active"data-level="4.8.1"data-path="./"><a href="./">rev - coffee_overflow</a></li></ul></li><li class="header">My Tasks</li><li class="header">2018</li><li class="chapter"data-level="6.1"><span>AIS3 Final</span><ul class="articles"><li class="chapter"data-level="6.1.1"data-path="../../../../tasks/2018/ais3Final/crypto/100-mama/"><a href="../../../../tasks/2018/ais3Final/crypto/100-mama/">crypto - mama</a></li><li class="chapter"data-level="6.1.2"data-path="../../../../tasks/2018/ais3Final/crypto/200-secureSub/"><a href="../../../../tasks/2018/ais3Final/crypto/200-secureSub/">crypto - secureSub</a></li><li class="chapter"data-level="6.1.3"data-path="../../../../tasks/2018/ais3Final/crypto/300-xorlnarmoni'akda/"><a href="../../../../tasks/2018/ais3Final/crypto/300-xorlnarmoni'akda/">crypto - xorlnarmoni'akda</a></li><li class="chapter"data-level="6.1.4"data-path="../../../../tasks/2018/ais3Final/rev/100-SecDES/"><a href="../../../../tasks/2018/ais3Final/rev/100-SecDES/">rev - SecDES</a></li><li class="chapter"data-level="6.1.5"data-path="../../../../tasks/2018/ais3Final/rev/200-AlmightyDuctTape/"><a href="../../../../tasks/2018/ais3Final/rev/200-AlmightyDuctTape/">rev - Almighty Duct Tape</a></li></ul></li><li class="divider"></li><li><a href="https://www.gitbook.com"target="blank"class="gitbook-link">Published with GitBook</a></li></ul></nav></div><div class="book-body"><div class="body-inner"><div class="book-header"role="navigation"><h1><i class="fa fa-circle-o-notch fa-spin"></i> <a href="../../../..">rev - coffee_overflow</a></h1></div><div class="page-wrapper"role="main"tabindex="-1"><div class="page-inner"><div id="book-search-results"><div class="search-noresults"><section class="markdown-section normal"><div class="wpHeaderContainer"><h1 id="coffeeoverflow">coffee_overflow</h1><div><span><a href="https://github.com/sasdf/ctf/blob/master/writeup/2018/HackIT/coffee_overflow"target="_blank"><img alt="Attachments"src="https://img.shields.io/badge/-Attachments-lightgrey.svg?style=for-the-badge&amp;maxAge=3600&amp;logo=github"></a></span><span><img alt="rev - 1000"src="https://img.shields.io/badge/rev-1000-green.svg?style=for-the-badge&amp;maxAge=3600"></span><span><img alt="1 solves"src="https://img.shields.io/badge/solves-1-lightseagreen.svg?style=for-the-badge&amp;maxAge=3600"></span></div></div><p></p><blockquote><p>Our mobile developer has severe coffee overflow, and lost password to his own app. Please help him to recover.</p></blockquote><h2 id="hints">Hints</h2><p>Do you have any idea how to ede?<br>How it may be connected with IDEA? EDE is also not only the city in Netherlands.</p><h2 id="time">Time</h2><p>20 hours, a little bit crazy...</p><h1 id="solution">Solution</h1><p>This is a java reverse challenge with obfuscation. I&apos;ll try to write down the whole process how I reverse it, it is a little bit lengthy. You&apos;ll see how I defeat those obfuscation techniques in detail.</p><h2 id="tldr">TL;DR</h2><ul><li>Rename the spaces.</li><li>Fix the signature.</li><li>Decrypt the string constants.</li><li>Recover the function name of InvokeDynamic</li><li>Recover the integer constants.</li><li>Read the bytecode, the bytecode, and the bytecodes.</li><li>Decrypt the flag</li></ul><h2 id="programs-behavior">Program&apos;s behavior</h2><p>Execute it without argument gives me:</p><pre class="language-"><code>i can haz password? usage: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>me</span><span class="token punctuation">&gt;</span></span> password
</code></pre><p>But it still output the same message even if I pass some arguments to it...</p><h2 id="get-started">Get started</h2><p>Every Java reverse challenge starts with opening it using <code>jd-gui</code>. The name of class, method, field are obfuscated, and there&apos;s some internal error when decompiling.</p><p>Open it with editor you can find a string &quot;Obfuscation by Radon obfuscator developed by ItzSomebody&quot; at the bottom. Searching for a deobfuscator for Radon but didn&apos;t found anything.</p><p>Ok, let&apos;s try some other decompilers like <code>CFR</code>, <code>Luyten(Procyon)</code> ... And none of them worked.</p><p>How about disassembler? <code>Bytecode Viewer</code> seems works, at least it shows some bytecode.</p><h2 id="fix-the-names">Fix the names</h2><p>The output of bytecode viewer is not very readable: the names are composed of many unicode spaces (U+2000 ~ U+200f), they are not distinguishable.</p><p>Those spaces in utf8 is <code>E2 80 8x</code>, so I replaced them with <code>_x_</code> to create unique, distinguishable and legal identifier names. Jar is actually a zip file, you have to unzip to modify the files in it.</p><p>Here&apos;s my <a href="https://github.com/sasdf/ctf/blob/master/writeup/2018/HackIT/coffee_overflow/_files/rename.py"target="_blank">script</a> to walk through all the files and change their filename and content.</p><p>Great, after packing it back to jar and opening with bytecode viewer, we produce some bytecodes that is readable.</p><p>Before we start dig into the bytecode, let&apos;s see a special file named <code>META-INF/MANIFEST.MF</code> in the jar.</p><pre class="language-"><code>Manifest-Version: 1.0
Created-By: 1.7.0_06 (Oracle Corporation)
Main-Class: _9__6__c__d__f__3__5__d__0__0_._7__9__6__f__f__7__e__3__e__f_
</code></pre><p>It specify where the entry point is.</p><p>I can find the file named <code>96cd.../796f....class</code> in the jar, but it&apos;s not in my bytecode viewer. Drag the classfile into bytecode viewer gives me <code>java.lang.IllegalArgumentException</code>.</p><p>What&apos;s going wrong??</p><h2 id="fix-the-signature">Fix the signature</h2><p>After trying other disassembler, I found <code>javap</code> (a disasm tool in JDK) reports an interesting error:</p><pre class="language-"><code>Error: A serious internal error has occurred: java.lang.IllegalStateException: !_!b__a__2__2__4__8__b__4__5__6_
Please file a bug report, and include the following information:
java.lang.IllegalStateException: !_!b__a__2__2__4__8__b__4__5__6_
        at jdk.jdeps/com.sun.tools.classfile.Signature.parseTypeSignature(Signature.java:180)
        at jdk.jdeps/com.sun.tools.classfile.Signature.parse(Signature.java:104)
        at jdk.jdeps/com.sun.tools.classfile.Signature.getType(Signature.java:48)
        at jdk.jdeps/com.sun.tools.javap.ClassWriter.write(ClassWriter.java:219)
        at jdk.jdeps/com.sun.tools.javap.JavapTask.write(JavapTask.java:836)
        at jdk.jdeps/com.sun.tools.javap.JavapTask.writeClass(JavapTask.java:655)
        at jdk.jdeps/com.sun.tools.javap.JavapTask.run(JavapTask.java:600)
        at jdk.jdeps/com.sun.tools.javap.JavapTask.run(JavapTask.java:450)
        at jdk.jdeps/com.sun.tools.javap.Main.main(Main.java:47)
</code></pre><p>What is a valid signature? I found some CFG in <a href="https://docs.oracle.com/javase/specs/jvms/se10/html/jvms-4.html#jvms-4.7.9.1"target="_blank">JVM doc</a> about the signature. And <code>Lxxx;</code> seems to be a valid signature. I replace the signature using hex editor, and now <code>javap</code> can disassemble it!!!</p><p>Bytecode viewer still crashed, so I disassemble all the classfile with <code>javap</code>, and start to work with them using Sublime text.</p><p>Also, when editing the signature, I found a string <code>RADON0.8.2</code>, which tells me about the version of obfuscator.</p><h2 id="decrypt-string-constants">Decrypt string constants</h2><p>After looking around the bytecode, I found a interesting part at the beginning.</p><pre class="language-"><code>64: invokedynamic #45,  0             // InvokeDynamic #1:_3__7__d__e__1__a__3__0__e__1_:()Ljava/io/PrintStream;
69: iconst_0
70: invokestatic  #49                 // Method _8__1__8__6__a__1__b__c__6__e_:(I)Ljava/lang/String;
73: aconst_null
74: ldc           #50                 // int 37329
76: invokestatic  #54                 // Method _d__7__b__5__e__2__f__a__f__c_._9__e__f__1__c__0__6__5__1__7_:(Ljava/lang/Object;Ljava/lang/Object;I)Ljava/lang/String;
</code></pre><p>I can&apos;t find <code>37de...</code> appears in other places, but let&apos;s ignore it now.</p><p>Hmm, <code>PrintStream</code>... It seems going to output something. <code>8186...</code> is a function at the bottom, which takes a index and return a garbled string in its string table. Also, in every place <code>8186...</code> is called, the return string are always passed into <code>d7b5.../9ef1...</code> and return another string.</p><p>A string table and a function decrypt it? Looks like how obfuscator works. After digging into Radon&apos;s source code, I found that <code>9ef1...</code> looks like <a href="https://github.com/ItzSomebody/Radon/blob/0.8.2/src/main/java/me/itzsomebody/radon/templates/NormalStringEncryption.java"target="_blank">Normal String Encryption</a> based on the functions they called. Their source code is obfuscated, <a href="https://github.com/sasdf/ctf/blob/master/writeup/2018/HackIT/coffee_overflow/_files/radonMethods"target="_blank">Here&apos;s</a> the code after cleaning up.</p><p>The encryption is actually single char xor. I&apos;m too lazy to calculate the key, so I just brute all the 256 keys and chose the best one manually. All the five strings in entry classfile is:</p><pre class="language-"><code>i can haz password? usage: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>me</span><span class="token punctuation">&gt;</span></span> password
rabbit hole
nice kitten
mad dog!
the winrar is u! subit password as flag!
</code></pre><p>Next, let&apos;s deal with dynamic invocation.</p><h2 id="recover-dynamic-invocation">Recover Dynamic Invocation</h2><p>Invoke dynamic works like PLT in C binary. It will call a resolver that will return the correct function first. The difference is that we can provide our own resolver and its argument. If you run <code>javap</code> with verbose switch on, it will output this at the bottom:</p><pre class="language-"><code>BootstrapMethods:
  0: #21 REF_invokeStatic _d__7__b__5__e__2__f__a__f__c_._5__a__e__3__9__2__6__4__a__8_:(Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;
    Method arguments:
      #22 1
      #23 0
      #25 ????????????????
      #27 ??????
      #29 ???
  1: #21 REF_invokeStatic _d__7__b__5__e__2__f__a__f__c_._5__a__e__3__9__2__6__4__a__8_:(Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;
    Method arguments:
      #23 0
      #22 1
      #37 ????????????????
      #39 ???
      #41 ???????????????????
</code></pre><p>It tells me that <code>d7b5.../5ae3...</code> is the resolver. In the same folder of radon&apos;s string encryption source code, there are some filename contains <code>InvokeDynamic</code>. It seems to be <a href="https://github.com/ItzSomebody/Radon/blob/0.8.2/src/main/java/me/itzsomebody/radon/templates/HeavyInvokeDynamic.java"target="_blank">Heavy Invoke Dynamic</a> based on the switch statment they use.</p><p>It encrypt className with single char xor using 4382, memberName using 3940, and descriptor using 5739.</p><p>Here&apos;s the <a href="https://github.com/sasdf/ctf/blob/master/writeup/2018/HackIT/coffee_overflow/_files/invokeSolver.py"target="_blank">script</a> to put the correct function name in its comment.</p><p>Now, previous snippet about the print looks like:</p><pre class="language-"><code>64: invokedynamic #45,  0             //  InvokeDynamic #1: java.lang.System/out:java.io.PrintStream
69: iconst_0
70: invokestatic  #49                 // Method &quot;8__1__8__6__a__1__b__c__6__e__&quot;:(I)Ljava/lang/String;
73: aconst_null
74: ldc           #50                 // int 37329
76: invokestatic  #54                 // Method d__7__b__5__e__2__f__a__f__c__.&quot;9__e__f__1__c__0__6__5__1__7__&quot;:(Ljava/lang/Object;Ljava/lang/Object;I)Ljava/lang/String;
79: invokedynamic #64,  0             //  InvokeDynamic #2: java.io.PrintStream/println:(Ljava/lang/String;)V
</code></pre><p>Looks much better, right?</p><h2 id="recover-integer-constants">Recover integer constants</h2><p>There are many bytecode have following pattern:</p><pre class="language-"><code>46: ldc           #34                 // int 814620811
48: ldc           #35                 // int 814620819
50: ixor
</code></pre><p>The answer is 24, that&apos;s how radon obfuscate integer constants. Here&apos;s the <a href="https://github.com/sasdf/ctf/blob/master/writeup/2018/HackIT/coffee_overflow/_files/processXor.py"target="_blank">script</a> calculate the result and put in its comment. Now, it looks like:</p><pre class="language-"><code>34: aload_0
35: ldc           #14                 // int 530953560
37: ldc           #14                 // int 530953560
39: ixor                              // eql 0
40: aaload
41: invokedynamic #33,  0             // InvokeDynamic #0: java.lang.String/length:()I
46: ldc           #34                 // int 814620811
48: ldc           #35                 // int 814620819
50: ixor                              // eql 24
51: if_icmpeq     102
</code></pre><p>Great, I can understand the bytecode now: It check that the first argument should be 24 chars long.</p><h2 id="human-decompiler">Human decompiler</h2><p>We have all the pieces now. It&apos;s time to spent 8hr reading the bytecodes :)</p><p>Here&apos;s some tips to read them:</p><h4 id="where-to-read">Where to read?</h4><p>Most of file/function is not used in the program due to the nature of java. You may better read the code along its exection flow (either reversed or forward).</p><h4 id="useless-prologue">Useless prologue</h4><p>All the function starts with something like this:</p><pre class="language-"><code>0: getstatic     #11                 // Field b__5__7__3__a__4__4__b__3__3__:Z
3: istore        6
5: goto          9
8: return
</code></pre><p>It&apos;s useless, just remove it.</p><h4 id="nop-on-statement-boundary">Nop on statement boundary</h4><p>There a lot of code like this in everywhere:</p><pre class="language-"><code> 9: iload         6
11: ifne          8
14: iload         6
16: ifne          8
</code></pre><p>It&apos;s also useless, but you may better left a newline when you replace it. It&apos;s a awesome boundary that can help you split the bytecode into smaller fragments.</p><h4 id="jump-and-loop">Jump and loop</h4><p>When you see something like:</p><pre class="language-"><code> 84: iload         6
 86: ifne          8
 89: iload         6
 91: iconst_0
 92: if_icmpeq     837
 95: aconst_null
 96: athrow
 97: nop
 98: nop
 99: nop
100: nop
101: athrow
</code></pre><p>It&apos;s actually <code>jmp 837</code>. It may be a if-else clause or a while/for loop, depending on the jumping direction.</p><h4 id="store">Store</h4><p>Store commands (<code>istore</code>, <code>iastore</code>, <code>bastore</code>) are also great boundaries too. Psuedo code of each fragments will looks like <code>reg5 = a * b(4) + 1</code></p><h2 id="decrypt-the-flag">Decrypt the flag</h2><p>Here&apos;s the psuedo code I recovered:</p><pre class="language-"><code class="lang-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainPackage<span class="token punctuation">.</span>MainClass</span> <span class="token keyword">extends</span> <span class="token class-name">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Object</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span><span class="token punctuation">)</span>V
    Code<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> and <span class="token function">len</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">24</span><span class="token operator">:</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;i can haz password? usage: &lt;me&gt; password&quot;</span><span class="token punctuation">)</span>
        pwd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PasswordEncryptor</span><span class="token punctuation">(</span><span class="token string">&quot;rabbit hole&quot;</span><span class="token punctuation">)</span> <span class="token comment">// IDEA Cipher</span>
        inp2 <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        inp3 <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        pwd<span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span><span class="token string">&quot;nice kitten&quot;</span><span class="token punctuation">)</span>
        pwd<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>inp2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> inp3<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// input, offset, output, offset</span>
        pwd<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>inp2<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> inp3<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>
        pwd<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>inp2<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> inp3<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
        pwd<span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span><span class="token string">&quot;mad dog!&quot;</span><span class="token punctuation">)</span>
        pwd<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>inp3<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> inp2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        pwd<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>inp3<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> inp2<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>
        pwd<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>inp3<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> inp2<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

        target <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token number">153</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">,</span> <span class="token number">234</span><span class="token punctuation">,</span> <span class="token number">183</span><span class="token punctuation">,</span> <span class="token number">183</span><span class="token punctuation">,</span> <span class="token number">247</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">39</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">57</span><span class="token punctuation">,</span>
            <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">159</span><span class="token punctuation">,</span> <span class="token number">247</span><span class="token punctuation">,</span> <span class="token number">124</span><span class="token punctuation">,</span> <span class="token number">43</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">199</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">]</span>

        <span class="token keyword">for</span> a<span class="token punctuation">,</span> b in <span class="token function">zip</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> inp2<span class="token punctuation">)</span><span class="token operator">:</span>
            <span class="token keyword">if</span> a <span class="token operator">!=</span> b<span class="token operator">:</span>
                <span class="token keyword">return</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;win&quot;</span><span class="token punctuation">)</span>
</code></pre><p>Hey bro, its NOT EDE mode... In 3DES, EDE mode is <code>Enc(Dec(Enc(msg, k1), k2), k3)</code> which makes the key 3 times longer. I double checked the bytecode, but didn&apos;t found any mistake.</p><p>I wrote a script to use PyCrypto&apos;s IDEA Cipher to decrypt the flag, but failed. I checked the bytecode third time, but still didn&apos;t found any mistake. The nightmare begins now. I thought the author may modified the algorithm, so I spent another 4 hours recovering all the details of its IDEA algorithm. and 2 hours debugging my decryption algorithm.</p><p>I&apos;ll skip the part of reversing, let&apos;s talk about how I debug the code.</p><h2 id="debug">Debug</h2><p>I very surprised that there&apos;s no bytecode level debugger like gdb in JDK. I&apos;ve tried some debuggers:</p><ul><li>I have totally no idea how to use jbcd.</li><li>Bytecode Viewer can&apos;t open some of the classfiles</li><li>Some debugger is too fat that I want to avoid. (e.g. plugin of eclipse)</li></ul><p>So I go with a different approach: write another java program to import the classfile. Unicode are legal identifiers in java (you may need to compile with <code>javac -encoding utf8</code>). When I tried to compile this code:</p><pre class="language-"><code class="lang-java"><span class="token keyword">import</span> &#x2009;&#x2006;&#x200C;&#x200D;&#x200F;&#x2003;&#x2005;&#x200D;&#x2000;&#x2000;<span class="token punctuation">.</span>&#x2007;&#x2009;&#x2006;&#x200F;&#x200F;&#x2007;&#x200E;&#x2003;&#x200E;&#x200F;<span class="token punctuation">;</span> <span class="token comment">// These spaces means PasswordEncryptor in the pseudo code above</span>
<span class="token comment">// test.java:1: error: illegal character: &apos;\u200f&apos;</span>
</code></pre><p>How about running the renamer above to change the name? Here the error message:</p><pre class="language-"><code class="lang-java"><span class="token keyword">import</span> _0__3__5__6__6__2__2__9__1__b_<span class="token punctuation">.</span>_2__5__4__e__4__4__9__5__7__1_<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  _2__5__4__e__4__4__9__5__7__1_ encryptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_2__5__4__e__4__4__9__5__7__1_</span><span class="token punctuation">(</span><span class="token string">&quot;nice kitten&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment">/*
test.java:22: error: cannot find symbol
        _2__5__4__e__4__4__9__5__7__1_ encryptor =      new _2__5__4__e__4__4__9__5__7__1_(&quot;nice kitten&quot;);
                                                        ^
  symbol:   constructor _2__5__4__e__4__4__9__5__7__1_(String)
  location: class _2__5__4__e__4__4__9__5__7__1_
test.java:25: error: cannot access b__3__6__e__6__0__a__f__d__1
        printarr(encryptor._c__2__c__0__a__9__0__f__1__4_, 52, 6);
                          ^
  class file for b__3__6__e__6__0__a__f__d__1 not found
*/</span>
</code></pre><p><code>b36e...</code> is the signature of that classfile, where it should point to its superclass. After fixing the signature, it still complains that it can&apos;t find the constructor.</p><p>I have no idea how to fix the classfile. I use another hacky method to come over this problem. Create a placeholder package which has same interface as our target:</p><pre class="language-"><code class="lang-java"><span class="token keyword">package</span> _0__3__5__6__6__2__2__9__1__b_<span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">_2__5__4__e__4__4__9__5__7__1_</span> <span class="token keyword">extends</span> <span class="token class-name">Object</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> _a__f__8__d__e__a__1__c__9__3_<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> _c__2__c__0__a__9__0__f__1__4_<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">_2__5__4__e__4__4__9__5__7__1_</span><span class="token punctuation">(</span>String key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_a__f__8__d__e__a__1__c__9__3_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">52</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_c__2__c__0__a__9__0__f__1__4_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">52</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">_3__0__7__8__8__0__f__9__6__9_</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inp<span class="token punctuation">,</span> <span class="token keyword">int</span> offInp<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> out<span class="token punctuation">,</span> <span class="token keyword">int</span> offOut<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">_1__6__7__e__5__4__f__7__a__b_</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>After compiling our code, substitute spaces for <code>_x_</code> back (See <a href="https://github.com/sasdf/ctf/blob/master/writeup/2018/HackIT/coffee_overflow/_files/renameBack.py"target="_blank">this script</a>) and it will call the function I want. Now, I can start debugging my decryption algorithm, or simply call the library to decrypt the flag.</p><h1 id="discussion-with-author-solarwind">Discussion with author (@Solarwind)</h1><ul><li>He use <code>acme</code> package for IDEA Cipher and didn&apos;t modify anything. I not sure which implementation is wrong. But <code>PyCrypto</code> had removed its IDEA code due to patent issue after version <code>2.0.2</code>.</li><li>He tells me a interesting technique called <code>Java agent</code> to do instrumentation.</li><li><code>java-deobfuscator</code> supports for <code>stringer</code>, which has similar obfuscation techniques. You can refer to their code to understand the way of writing a deobfuscator.</li></ul></section></div><div class="search-results"><div class="has-results"><h1 class="search-results-title"><span class="search-results-count"></span> results matching "<span class="search-query"></span>"</h1><ul class="search-results-list"></ul></div><div class="no-results"><h1 class="search-results-title">No results matching "<span class="search-query"></span>"</h1></div></div></div></div></div></div></div><script>var gitbook=gitbook||[];gitbook.push(function(){gitbook.page.hasChanged({page:{name:"coffee_overflow",category:"rev",points:1e3,solves:1,title:"rev - coffee_overflow",level:"4.8.1",depth:2,next:{title:"AIS3 Final",level:"6.1",depth:1,ref:"",articles:[{title:"crypto - mama",level:"6.1.1",depth:2,path:"tasks/2018/ais3Final/crypto/100-mama/README.md",ref:"tasks/2018/ais3Final/crypto/100-mama/README.md",articles:[]},{title:"crypto - secureSub",level:"6.1.2",depth:2,path:"tasks/2018/ais3Final/crypto/200-secureSub/README.md",ref:"tasks/2018/ais3Final/crypto/200-secureSub/README.md",articles:[]},{title:"crypto - xorlnarmoni'akda",level:"6.1.3",depth:2,path:"tasks/2018/ais3Final/crypto/300-xorlnarmoni'akda/README.md",ref:"tasks/2018/ais3Final/crypto/300-xorlnarmoni'akda/README.md",articles:[]},{title:"rev - SecDES",level:"6.1.4",depth:2,path:"tasks/2018/ais3Final/rev/100-SecDES/README.md",ref:"tasks/2018/ais3Final/rev/100-SecDES/README.md",articles:[]},{title:"rev - Almighty Duct Tape",level:"6.1.5",depth:2,path:"tasks/2018/ais3Final/rev/200-AlmightyDuctTape/README.md",ref:"tasks/2018/ais3Final/rev/200-AlmightyDuctTape/README.md",articles:[]}]},previous:{title:"HackIT",level:"4.8",depth:1,ref:"",articles:[{title:"rev - coffee_overflow",level:"4.8.1",depth:2,path:"writeup/2018/HackIT/coffee_overflow/README.md",ref:"writeup/2018/HackIT/coffee_overflow/README.md",articles:[]}]},dir:"ltr"},config:{gitbook:"*",theme:"default",variables:{},plugins:["katex@git://github.com/sasdf/plugin-katex.git","disqus","prism","-highlight","html-minifier","writeup-utils@git://github.com/sasdf/gitbook-plugin-writeup-utils.git"],pluginsConfig:{prism:{css:["prismjs/themes/prism-tomorrow.css"],lang:{C:"c","C++":"cpp",asm:"nasm"}},disqus:{useIdentifier:!1,shortName:"sasdfwriteup"},search:{},"html-minifier":{customAttrSurround:[],removeScriptTypeAttributes:!1,removeEmptyAttributes:!1,removeRedundantAttributes:!1,removeEmptyElements:!1,sortClassName:!0,caseSensitive:!0,html5:!0,collapseWhitespace:!0,processConditionalComments:!1,quoteCharacter:null,keepClosingSlash:!0,preventAttributesEscaping:!1,minifyURLs:!1,removeAttributeQuotes:!1,decodeEntities:!1,trimCustomFragments:!1,customAttrAssign:[],includeAutoGeneratedTags:!0,collapseInlineTagWhitespace:!1,collapseBooleanAttributes:!0,minifyJS:!0,removeTagWhitespace:!0,preserveLineBreaks:!1,sortAttributes:!0,removeStyleLinkTypeAttributes:!1,removeComments:!0,minifyCSS:!0,processScripts:[],conservativeCollapse:!1,removeOptionalTags:!1,useShortDoctype:!1},lunr:{maxIndexSize:1e6,ignoreSpecialCharacters:!1},katex:{},fontsettings:{theme:"white",family:"sans",size:2},sharing:{facebook:!0,twitter:!0,google:!1,weibo:!1,instapaper:!1,vk:!1,all:["facebook","google","twitter","weibo","instapaper"]},"theme-default":{styles:{website:"styles/website.css",pdf:"styles/pdf.css",epub:"styles/epub.css",mobi:"styles/mobi.css",ebook:"styles/ebook.css",print:"styles/print.css"},showLevel:!1},"writeup-utils":{filePrefix:"https://github.com/sasdf/ctf/blob/master",repoPrefix:"https://github.com/sasdf/ctf/blob/master"}},structure:{langs:"LANGS.md",readme:"README.md",glossary:"GLOSSARY.md",summary:"SUMMARY.md"},pdf:{pageNumbers:!0,fontSize:12,fontFamily:"Arial",paperSize:"a4",chapterMark:"pagebreak",pageBreaksBefore:"/",margin:{right:62,left:62,top:56,bottom:56}},styles:{website:"styles/website.css",pdf:"styles/pdf.css",epub:"styles/epub.css",mobi:"styles/mobi.css",ebook:"styles/ebook.css",print:"styles/print.css"}},file:{path:"writeup/2018/HackIT/coffee_overflow/README.md",mtime:"2018-12-02T20:01:20.000Z",type:"markdown"},gitbook:{version:"3.2.3",time:"2019-04-16T18:12:31.358Z"},basePath:"../../../..",book:{language:""}})})</script></div><script src="../../../../gitbook/gitbook.js"></script><script src="../../../../gitbook/theme.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script><script src="../../../../gitbook/gitbook-plugin-disqus/plugin.js"></script><script src="../../../../gitbook/gitbook-plugin-search/search-engine.js"></script><script src="../../../../gitbook/gitbook-plugin-search/search.js"></script><script src="../../../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script><script src="../../../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script><script src="../../../../gitbook/gitbook-plugin-sharing/buttons.js"></script><script src="../../../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script></body></html>