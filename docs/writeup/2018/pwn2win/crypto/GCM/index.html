<!DOCTYPE HTML><html lang=""><head><meta charset="UTF-8"><meta content="text/html; charset=utf-8"http-equiv="Content-Type"><title>crypto - GCM Â· GitBook</title><meta content="IE=edge"http-equiv="X-UA-Compatible"/><meta content=""name="description"><meta content="GitBook 3.2.3"name="generator"><link href="../../../../../gitbook/style.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-katex/katex.min.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-disqus/plugin.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-prism/prism-tomorrow.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-writeup-utils/plugin.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-search/search.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-fontsettings/website.css"rel="stylesheet"><meta content="true"name="HandheldFriendly"/><meta content="width=device-width,initial-scale=1,user-scalable=no"name="viewport"><meta content="yes"name="apple-mobile-web-app-capable"><meta content="black"name="apple-mobile-web-app-status-bar-style"><link href="../../../../../gitbook/images/apple-touch-icon-precomposed-152.png"rel="apple-touch-icon-precomposed"sizes="152x152"><link href="../../../../../gitbook/images/favicon.ico"rel="shortcut icon"type="image/x-icon"><link href="../../rev/back_to_bletchley_park/"rel="prev"/></head><body><div class="book"><div class="book-summary"><div role="search"id="book-search-input"><input placeholder="Type to search"type="text"/></div><nav role="navigation"><ul class="summary"><li class="chapter"data-level="1.1"data-path="../../../../../"><a href="../../../../../">Introduction</a></li><li class="header">Writeups</li><li class="header">2018</li><li class="chapter"data-level="3.1"><span>hxp</span><ul class="articles"><li class="chapter"data-level="3.1.1"data-path="../../../hxp/crypto/blinder/"><a href="../../../hxp/crypto/blinder/">crypto - blinder</a></li><li class="chapter"data-level="3.1.2"data-path="../../../hxp/crypto/curve/"><a href="../../../hxp/crypto/curve/">crypto - curve12833227</a></li><li class="chapter"data-level="3.1.3"data-path="../../../hxp/crypto/oops/"><a href="../../../hxp/crypto/oops/">crypto - oops2</a></li><li class="chapter"data-level="3.1.4"data-path="../../../hxp/crypto/blind/"><a href="../../../hxp/crypto/blind/">crypto - blind</a></li></ul></li><li class="chapter"data-level="3.2"><span>Pwn2Win</span><ul class="articles"><li class="chapter"data-level="3.2.1"data-path="../../rev/back_to_bletchley_park/"><a href="../../rev/back_to_bletchley_park/">cryrev - Back To Bletchley Park</a></li><li class="chapter active"data-level="3.2.2"data-path="./"><a href="./">crypto - GCM</a></li></ul></li><li class="chapter"data-level="3.3"><span>HITCON</span><ul class="articles"><li class="chapter"data-level="3.3.1"data-path="../../../hitcon/crypto/lostmod/"><a href="../../../hitcon/crypto/lostmod/">crypto - Lost Modulus</a></li><li class="chapter"data-level="3.3.2"data-path="../../../hitcon/crypto/secret/"><a href="../../../hitcon/crypto/secret/">crypwn - Secret Note</a></li></ul></li><li class="chapter"data-level="3.4"><span>Hack.lu</span><ul class="articles"><li class="chapter"data-level="3.4.1"data-path="../../../Hack.lu/crypto/escape/"><a href="../../../Hack.lu/crypto/escape/">crypto - Escape the Grid</a></li><li class="chapter"data-level="3.4.2"data-path="../../../Hack.lu/crypto/relation/"><a href="../../../Hack.lu/crypto/relation/">crypto - Relations</a></li><li class="chapter"data-level="3.4.3"data-path="../../../Hack.lu/crypto/lfsr/"><a href="../../../Hack.lu/crypto/lfsr/">crypto - LFSR StreamCipher</a><ul class="articles"><li class="chapter"data-level="3.4.3.1"data-path="../../../Hack.lu/crypto/lfsr/task.html"><a href="../../../Hack.lu/crypto/lfsr/task.html">task description</a></li></ul></li></ul></li><li class="chapter"data-level="3.5"><span>Hackover</span><ul class="articles"><li class="chapter"data-level="3.5.1"data-path="../../../HackOver/crypto/oblivious/"><a href="../../../HackOver/crypto/oblivious/">crypto - oblivious</a></li><li class="chapter"data-level="3.5.2"data-path="../../../HackOver/crypto/secure_hash_v2/"><a href="../../../HackOver/crypto/secure_hash_v2/">crypto - secure_hash_v2</a></li><li class="chapter"data-level="3.5.3"data-path="../../../HackOver/rev/flagmaker/"><a href="../../../HackOver/rev/flagmaker/">rev - flagmaker</a></li></ul></li><li class="chapter"data-level="3.6"><span>Teaser Dragon</span><ul class="articles"><li class="chapter"data-level="3.6.1"data-path="../../../TeaserDragon/rev/Chains of trust/"><a href="../../../TeaserDragon/rev/Chains of trust/">rev - Chains of trust</a></li></ul></li><li class="chapter"data-level="3.7"><span>Defcamp</span><ul class="articles"><li class="chapter"data-level="3.7.1"data-path="../../../defcamp/rev/validator/"><a href="../../../defcamp/rev/validator/">rev - validator</a></li><li class="chapter"data-level="3.7.2"data-path="../../../defcamp/rev/memsome/"><a href="../../../defcamp/rev/memsome/">rev - memsome</a></li><li class="chapter"data-level="3.7.3"data-path="../../../defcamp/web/secops/"><a href="../../../defcamp/web/secops/">web - secops</a></li><li class="chapter"data-level="3.7.4"data-path="../../../defcamp/web/chat/"><a href="../../../defcamp/web/chat/">web - chat</a></li><li class="chapter"data-level="3.7.5"data-path="../../../defcamp/misc/voices/"><a href="../../../defcamp/misc/voices/">misc - voices</a></li></ul></li><li class="chapter"data-level="3.8"><span>HackIT</span><ul class="articles"><li class="chapter"data-level="3.8.1"data-path="../../../HackIT/coffee_overflow/"><a href="../../../HackIT/coffee_overflow/">rev - coffee_overflow</a></li></ul></li><li class="header">My Tasks</li><li class="header">2018</li><li class="chapter"data-level="5.1"><span>AIS3 Final</span><ul class="articles"><li class="chapter"data-level="5.1.1"data-path="../../../../../tasks/2018/ais3Final/crypto/100-mama/"><a href="../../../../../tasks/2018/ais3Final/crypto/100-mama/">crypto - mama</a></li><li class="chapter"data-level="5.1.2"data-path="../../../../../tasks/2018/ais3Final/crypto/200-secureSub/"><a href="../../../../../tasks/2018/ais3Final/crypto/200-secureSub/">crypto - secureSub</a></li><li class="chapter"data-level="5.1.3"data-path="../../../../../tasks/2018/ais3Final/crypto/300-xorlnarmoni'akda/"><a href="../../../../../tasks/2018/ais3Final/crypto/300-xorlnarmoni'akda/">crypto - xorlnarmoni'akda</a></li><li class="chapter"data-level="5.1.4"data-path="../../../../../tasks/2018/ais3Final/rev/100-SecDES/"><a href="../../../../../tasks/2018/ais3Final/rev/100-SecDES/">rev - SecDES</a></li><li class="chapter"data-level="5.1.5"data-path="../../../../../tasks/2018/ais3Final/rev/200-AlmightyDuctTape/"><a href="../../../../../tasks/2018/ais3Final/rev/200-AlmightyDuctTape/">rev - Almighty Duct Tape</a></li></ul></li><li class="divider"></li><li><a href="https://www.gitbook.com"target="blank"class="gitbook-link">Published with GitBook</a></li></ul></nav></div><div class="book-body"><div class="body-inner"><div class="book-header"role="navigation"><h1><i class="fa fa-circle-o-notch fa-spin"></i> <a href="../../../../..">crypto - GCM</a></h1></div><div class="page-wrapper"role="main"tabindex="-1"><div class="page-inner"><div id="book-search-results"><div class="search-noresults"><section class="markdown-section normal"><div class="wpHeaderContainer"><h1 id="gcm">GCM</h1><div><span><a href="https://github.com/sasdf/ctf/blob/master/writeup/2018/pwn2win/crypto/GCM"target="_blank"><img alt="Attachments"src="https://img.shields.io/badge/-Attachments-lightgrey.svg?style=for-the-badge&amp;maxAge=3600&amp;logo=github"></a></span><span><img alt="crypto - 373"src="https://img.shields.io/badge/crypto-373-green.svg?style=for-the-badge&amp;maxAge=3600"></span><span><img alt="8 solves"src="https://img.shields.io/badge/solves-8-lightseagreen.svg?style=for-the-badge&amp;maxAge=3600"></span></div></div><p></p><blockquote><p>There is only one method of performing bank transactions that can not be monitored by The Bavarian. It&apos;s not an ATM, but a secret system.</p></blockquote><h2 id="time">Time</h2><p>3 hours</p><h1 id="behavior">Behavior</h1><pre class="language-"><code>.. nc 200.136.252.51 5555

Welcome to Tr4nsferw1s3! Please chose one of the options:
  [1] Login
  [2] Transfer/pay
  [3] Exit
1
Username: abc
Password: abc
Logged in as abc! Here is the token:
{&apos;enc&apos;: &apos;05a32e329fc834fad58ef89102b5d74ceed1a935bf36df445ce17f09f56794ce2b51cb4d8c2f9794e29e52bcf0c3df4c67fbade8b0fcfebc145d369922d7b9835c270d66305c178fac95e8d2c801fe07b9767eea89aa14b6de72c55351&apos;, &apos;tag&apos;: &apos;0116edb64e4a66fcf2bc2e722e59a610&apos;, &apos;iv&apos;: &apos;3928aba0f3629befcb300671&apos;}

Welcome to Tr4nsferw1s3! Please chose one of the options:
  [1] Login
  [2] Transfer/pay
  [3] Exit
2
Token: {&apos;enc&apos;: &apos;05a32e329fc834fad58ef89102b5d74ceed1a935bf36df445ce17f09f56794ce2b51cb4d8c2f9794e29e52bcf0c3df4c67fbade8b0fcfebc145d369922d7b9835c270d66305c178fac95e8d2c801fe07b9767eea89aa14b6de72c55351&apos;, &apos;tag&apos;: &apos;0116edb64e4a66fcf2bc2e722e59a610&apos;, &apos;iv&apos;: &apos;3928aba0f3629befcb300671&apos;}
Huh? you have no money and want the flag? -.-
</code></pre><h1 id="solution">Solution</h1><h2 id="tldr">TL;DR</h2><ol><li>Patch the token</li><li>Try all 256 truncated one byte tag</li></ol><p>The service encrypts the token with AES-GCM mode, iv is generated from urandom. It seems no vulnerbilities inside the crypto parts.</p><p>Our input is parsed with <code>ast.literal_eval</code>, which means we can send strange type in the payload. After I stucked on finding vulns of GCM mode, I started poking the service with strange payload.</p><h2 id="strange-behavior">Strange Behavior</h2><p>I tried to put something data type in tag or iv. It crashed the program but nothing intersting happened.</p><p>However, when I put empty string (or array/dict...) in tag:</p><pre class="language-"><code>.. nc 200.136.252.51 5555

Welcome to Tr4nsferw1s3! Please chose one of the options:
  [1] Login
  [2] Transfer/pay
  [3] Exit
1
Username: abc
Password: abc
Logged in as abc! Here is the token:
{&apos;enc&apos;: &apos;b31af0e48908c0d7850ad7803745909a3b3c95a7457c605860809eb0db9a1e52a53f195a9c99d88566a591f580d472cad64759ac8fc89af09b48f56dad36c55dd0b9f0bbb30ab2b64d3f11abca04bac635c2d3b37c2012b902b688aa63&apos;, &apos;tag&apos;: &apos;e7fe3cad3a227bee1a658ca4100bab86&apos;, &apos;iv&apos;: &apos;cc6a230be51e9faf8ae35abc&apos;}

Welcome to Tr4nsferw1s3! Please chose one of the options:
  [1] Login
  [2] Transfer/pay
  [3] Exit
2
Token: {&apos;enc&apos;: &apos;b31af0e48908c0d7850ad7803745909a3b3c95a7457c605860809eb0db9a1e52a53f195a9c99d88566a591f580d472cad64759ac8fc89af09b48f56dad36c55dd0b9f0bbb30ab2b64d3f11abca04bac635c2d3b37c2012b902b688aa63&apos;, &apos;tag&apos;: &apos;&apos;, &apos;iv&apos;: &apos;cc6a230be51e9faf8ae35abc&apos;}
Traceback (most recent call last):
  File &quot;/home/gcm/chall.py&quot;, line 79, in <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>
    menu()
  File &quot;/home/gcm/chall.py&quot;, line 71, in menu
    pay()
  File &quot;/home/gcm/chall.py&quot;, line 53, in pay
    account = ast.literal_eval(decryptor.update(enc) + decryptor.finalize_with_tag(tag))
  File &quot;/usr/local/lib/python2.7/dist-packages/cryptography/hazmat/primitives/ciphers/base.py&quot;, line 206, in finalize_with_tag
    data = self._ctx.finalize_with_tag(tag)
  File &quot;/usr/local/lib/python2.7/dist-packages/cryptography/hazmat/backends/openssl/ciphers.py&quot;, line 209, in finalize_with_tag
    self._backend.openssl_assert(res != 0)
  File &quot;/usr/local/lib/python2.7/dist-packages/cryptography/hazmat/backends/openssl/backend.py&quot;, line 105, in openssl_assert
    return binding._openssl_assert(self._lib, ok)
  File &quot;/usr/local/lib/python2.7/dist-packages/cryptography/hazmat/bindings/openssl/binding.py&quot;, line 76, in _openssl_assert
    errors_with_text
cryptography.exceptions.InternalError: Unknown OpenSSL error. This error is commonly encountered when another library is not cleaning up the OpenSSL error stack. If you are using cryptography with another library that uses OpenSSL try disabling it before reporting a bug. Otherwise please file an issue at https://github.com/pyca/cryptography/issues with information on how to reproduce this. ([])
</code></pre><p>And here&apos;s the output of my local python:</p><pre class="language-"><code>In [99]: dec.finalize_with_tag(b&apos;&apos;)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ipython-input-99-1ad91645a4ee</span><span class="token punctuation">&gt;</span></span> in <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>()
----&gt; 1 dec.finalize_with_tag(b&apos;&apos;)

/usr/local/lib/python3.7/site-packages/cryptography/hazmat/primitives/ciphers/base.py in finalize_with_tag(self, tag)
    204         if self._ctx is None:
    205             raise AlreadyFinalized(&quot;Context was already finalized.&quot;)
--&gt; 206         data = self._ctx.finalize_with_tag(tag)
    207         self._tag = self._ctx.tag
    208         self._ctx = None

/usr/local/lib/python3.7/site-packages/cryptography/hazmat/backends/openssl/ciphers.py in finalize_with_tag(self, tag)
    203             raise ValueError(
    204                 &quot;Authentication tag must be {0} bytes or longer.&quot;.format(
--&gt; 205                     self._mode._min_tag_length)
    206             )
    207         res = self._backend._lib.EVP_CIPHER_CTX_ctrl(

ValueError: Authentication tag must be 16 bytes or longer.
</code></pre><p>Hmm... the errors are not the same, what&apos;s going wrong?</p><p>I searched for the <a href="https://github.com/pyca/cryptography/blob/master/src/cryptography/hazmat/backends/openssl/ciphers.py#L202"target="_blank">source</a> in github, and it&apos;s same as my local version. It checks the length of tag first.</p><p>Then I try to find when this check is added. It was added in the <a href="https://github.com/pyca/cryptography/commit/d4378e42937b56f473ddade2667f919ce32208cb#diff-7f9182acb7dedf7b702ac6c6b98fd678"target="_blank">commit d4378e</a> , which is about tag truncation. It says:</p><blockquote><ul><li><strong>SECURITY ISSUE:</strong> :meth:<code>~cryptography.hazmat.primitives.ciphers.AEADDecryptionContext.finalize_with_tag</code> allowed tag truncation by default which can allow tag forgery in some cases. The method now enforces the <code>min_tag_length</code> provided to the :class:<code>~cryptography.hazmat.primitives.ciphers.modes.GCM</code> constructor.</li></ul></blockquote><p>Ah Ha!! We found the vulnerbilities.</p><p>Now, change <code>&quot;admin&quot;: &quot;N&quot;</code> to <code>&quot;admin&quot;: &quot;Y&quot;</code> by XOR, and then try all 256 one byte tag to get the flag. (<a href="https://github.com/sasdf/ctf/blob/master/writeup/2018/pwn2win/crypto/GCM/_files/solve.py"target="_blank">Script</a>)</p></section></div><div class="search-results"><div class="has-results"><h1 class="search-results-title"><span class="search-results-count"></span> results matching "<span class="search-query"></span>"</h1><ul class="search-results-list"></ul></div><div class="no-results"><h1 class="search-results-title">No results matching "<span class="search-query"></span>"</h1></div></div></div></div></div></div><a href="../../rev/back_to_bletchley_park/"class="navigation navigation-prev navigation-unique"aria-label="Previous page: cryrev - Back To Bletchley Park"><i class="fa fa-angle-left"></i></a></div><script>var gitbook=gitbook||[];gitbook.push(function(){gitbook.page.hasChanged({page:{name:"GCM",category:"crypto",points:373,solves:8,title:"crypto - GCM",level:"3.2.2",depth:2,next:{title:"HITCON",level:"3.3",depth:1,ref:"",articles:[{title:"crypto - Lost Modulus",level:"3.3.1",depth:2,path:"writeup/2018/hitcon/crypto/lostmod/README.md",ref:"writeup/2018/hitcon/crypto/lostmod/README.md",articles:[]},{title:"crypwn - Secret Note",level:"3.3.2",depth:2,path:"writeup/2018/hitcon/crypto/secret/README.md",ref:"writeup/2018/hitcon/crypto/secret/README.md",articles:[]}]},previous:{title:"cryrev - Back To Bletchley Park",level:"3.2.1",depth:2,path:"writeup/2018/pwn2win/rev/back_to_bletchley_park/README.md",ref:"writeup/2018/pwn2win/rev/back_to_bletchley_park/README.md",articles:[]},dir:"ltr"},config:{gitbook:"*",theme:"default",variables:{},plugins:["katex@git://github.com/sasdf/plugin-katex.git","disqus","prism","-highlight","html-minifier","writeup-utils@git://github.com/sasdf/gitbook-plugin-writeup-utils.git"],pluginsConfig:{prism:{css:["prismjs/themes/prism-tomorrow.css"],lang:{C:"c","C++":"cpp",asm:"nasm"}},disqus:{useIdentifier:!1,shortName:"sasdfwriteup"},search:{},"html-minifier":{customAttrSurround:[],removeScriptTypeAttributes:!1,removeEmptyAttributes:!1,removeRedundantAttributes:!1,removeEmptyElements:!1,sortClassName:!0,caseSensitive:!0,html5:!0,collapseWhitespace:!0,processConditionalComments:!1,quoteCharacter:null,keepClosingSlash:!0,preventAttributesEscaping:!1,minifyURLs:!1,removeAttributeQuotes:!1,decodeEntities:!1,trimCustomFragments:!1,customAttrAssign:[],includeAutoGeneratedTags:!0,collapseInlineTagWhitespace:!1,collapseBooleanAttributes:!0,minifyJS:!0,removeTagWhitespace:!0,preserveLineBreaks:!1,sortAttributes:!0,removeStyleLinkTypeAttributes:!1,removeComments:!0,minifyCSS:!0,processScripts:[],conservativeCollapse:!1,removeOptionalTags:!1,useShortDoctype:!1},lunr:{maxIndexSize:1e6,ignoreSpecialCharacters:!1},katex:{},fontsettings:{theme:"white",family:"sans",size:2},sharing:{facebook:!0,twitter:!0,google:!1,weibo:!1,instapaper:!1,vk:!1,all:["facebook","google","twitter","weibo","instapaper"]},"theme-default":{styles:{website:"styles/website.css",pdf:"styles/pdf.css",epub:"styles/epub.css",mobi:"styles/mobi.css",ebook:"styles/ebook.css",print:"styles/print.css"},showLevel:!1},"writeup-utils":{filePrefix:"https://github.com/sasdf/ctf/blob/master",repoPrefix:"https://github.com/sasdf/ctf/blob/master"}},structure:{langs:"LANGS.md",readme:"README.md",glossary:"GLOSSARY.md",summary:"SUMMARY.md"},pdf:{pageNumbers:!0,fontSize:12,fontFamily:"Arial",paperSize:"a4",chapterMark:"pagebreak",pageBreaksBefore:"/",margin:{right:62,left:62,top:56,bottom:56}},styles:{website:"styles/website.css",pdf:"styles/pdf.css",epub:"styles/epub.css",mobi:"styles/mobi.css",ebook:"styles/ebook.css",print:"styles/print.css"}},file:{path:"writeup/2018/pwn2win/crypto/GCM/README.md",mtime:"2018-12-02T20:01:20.678Z",type:"markdown"},gitbook:{version:"3.2.3",time:"2018-12-10T02:00:42.692Z"},basePath:"../../../../..",book:{language:""}})})</script></div><script src="../../../../../gitbook/gitbook.js"></script><script src="../../../../../gitbook/theme.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script><script src="../../../../../gitbook/gitbook-plugin-disqus/plugin.js"></script><script src="../../../../../gitbook/gitbook-plugin-search/search-engine.js"></script><script src="../../../../../gitbook/gitbook-plugin-search/search.js"></script><script src="../../../../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script><script src="../../../../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script><script src="../../../../../gitbook/gitbook-plugin-sharing/buttons.js"></script><script src="../../../../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script></body></html>