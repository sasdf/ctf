<!DOCTYPE HTML><html lang=""><head><meta charset="UTF-8"><meta content="text/html; charset=utf-8"http-equiv="Content-Type"><title>rev - plam Â· GitBook</title><meta content="IE=edge"http-equiv="X-UA-Compatible"/><meta content=""name="description"><meta content="GitBook 3.2.3"name="generator"><link href="../../../../../gitbook/style.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-katex/katex.min.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-disqus/plugin.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-prism/prism-tomorrow.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-writeup-utils/plugin.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-search/search.css"rel="stylesheet"><link href="../../../../../gitbook/gitbook-plugin-fontsettings/website.css"rel="stylesheet"><meta content="true"name="HandheldFriendly"/><meta content="width=device-width,initial-scale=1,user-scalable=no"name="viewport"><meta content="yes"name="apple-mobile-web-app-capable"><meta content="black"name="apple-mobile-web-app-status-bar-style"><link href="../../../../../gitbook/images/apple-touch-icon-precomposed-152.png"rel="apple-touch-icon-precomposed"sizes="152x152"><link href="../../../../../gitbook/images/favicon.ico"rel="shortcut icon"type="image/x-icon"><link href="../vim/"rel="next"/><link href="../../misc/john/"rel="prev"/></head><body><div class="book"><div class="book-summary"><nav role="navigation"><ul class="summary"><li class="chapter"data-level="1.1"data-path="../../../../../"><a href="../../../../../">Introduction</a></li><li class="header">Writeups</li><li class="header">2020</li><li class="chapter"data-level="3.1"><span>Google</span><ul class="articles"><li class="chapter"data-level="3.1.1"data-path="../../../../../writeup/2020/google/crypto/oracle/"><a href="../../../../../writeup/2020/google/crypto/oracle/">crypto - Oracle</a></li><li class="chapter"data-level="3.1.2"data-path="../../../../../writeup/2020/google/crypto/yafm/"><a href="../../../../../writeup/2020/google/crypto/yafm/">crypto - YAFM</a></li><li class="chapter"data-level="3.1.3"data-path="../../../../../writeup/2020/google/crypto/quantum/"><a href="../../../../../writeup/2020/google/crypto/quantum/">crypto - Quantum Pyramids</a></li><li class="chapter"data-level="3.1.4"data-path="../../../../../writeup/2020/google/crypto/sharky/"><a href="../../../../../writeup/2020/google/crypto/sharky/">crypto - SHArky</a></li></ul></li><li class="header">2019</li><li class="chapter"data-level="4.1"><span>Google</span><ul class="articles"><li class="chapter"data-level="4.1.1"data-path="../../../../../writeup/2019/google/crypto/reality/"><a href="../../../../../writeup/2019/google/crypto/reality/">crypto - reality</a></li><li class="chapter"data-level="4.1.2"data-path="../../../../../writeup/2019/google/crypto/qkd/"><a href="../../../../../writeup/2019/google/crypto/qkd/">crypto - Quantum Key Distribution</a></li><li class="chapter"data-level="4.1.3"data-path="../../../../../writeup/2019/google/crypto/cell/"><a href="../../../../../writeup/2019/google/crypto/cell/">crypto - Reverse a cellular automata</a></li><li class="chapter"data-level="4.1.4"data-path="../../../../../writeup/2019/google/hardware/flagrom/"><a href="../../../../../writeup/2019/google/hardware/flagrom/">hardware - flagrom</a></li><li class="chapter"data-level="4.1.5"data-path="../../../../../writeup/2019/google/hardware/minetest/"><a href="../../../../../writeup/2019/google/hardware/minetest/">hardware - minetest</a></li><li class="chapter"data-level="4.1.6"data-path="../../../../../writeup/2019/google/hardware/remote/"><a href="../../../../../writeup/2019/google/hardware/remote/">hardware - Remote Control</a></li><li class="chapter"data-level="4.1.7"data-path="../../../../../writeup/2019/google/web/glotto/"><a href="../../../../../writeup/2019/google/web/glotto/">web - gLotto</a></li><li class="chapter"data-level="4.1.8"data-path="../../../../../writeup/2019/google/rev/dial/"><a href="../../../../../writeup/2019/google/rev/dial/">rev - Dialtone</a></li></ul></li><li class="chapter"data-level="4.2"><span>Plaid</span><ul class="articles"><li class="chapter"data-level="4.2.1"data-path="../../../../../writeup/2019/plaid/crypto/cypress/"><a href="../../../../../writeup/2019/plaid/crypto/cypress/">crypto - SPlaid Cypress</a></li><li class="chapter"data-level="4.2.2"data-path="../../../../../writeup/2019/plaid/rev/bigmaffs/"><a href="../../../../../writeup/2019/plaid/rev/bigmaffs/">rev - big maffs</a></li></ul></li><li class="header">2018</li><li class="chapter"data-level="5.1"><span>hxp</span><ul class="articles"><li class="chapter"data-level="5.1.1"data-path="../../../../../writeup/2018/hxp/crypto/blinder_v2/"><a href="../../../../../writeup/2018/hxp/crypto/blinder_v2/">crypto - blinder_v2</a></li><li class="chapter"data-level="5.1.2"data-path="../../../../../writeup/2018/hxp/crypto/blinder/"><a href="../../../../../writeup/2018/hxp/crypto/blinder/">crypto - blinder</a></li><li class="chapter"data-level="5.1.3"data-path="../../../../../writeup/2018/hxp/crypto/curve/"><a href="../../../../../writeup/2018/hxp/crypto/curve/">crypto - curve12833227</a></li><li class="chapter"data-level="5.1.4"data-path="../../../../../writeup/2018/hxp/crypto/oops/"><a href="../../../../../writeup/2018/hxp/crypto/oops/">crypto - oops2</a></li><li class="chapter"data-level="5.1.5"data-path="../../../../../writeup/2018/hxp/crypto/blind/"><a href="../../../../../writeup/2018/hxp/crypto/blind/">crypto - blind</a></li></ul></li><li class="chapter"data-level="5.2"><span>Pwn2Win</span><ul class="articles"><li class="chapter"data-level="5.2.1"data-path="../../../../../writeup/2018/pwn2win/rev/back_to_bletchley_park/"><a href="../../../../../writeup/2018/pwn2win/rev/back_to_bletchley_park/">cryrev - Back To Bletchley Park</a></li><li class="chapter"data-level="5.2.2"data-path="../../../../../writeup/2018/pwn2win/crypto/GCM/"><a href="../../../../../writeup/2018/pwn2win/crypto/GCM/">crypto - GCM</a></li></ul></li><li class="chapter"data-level="5.3"><span>HITCON</span><ul class="articles"><li class="chapter"data-level="5.3.1"data-path="../../../../../writeup/2018/hitcon/crypto/lostmod/"><a href="../../../../../writeup/2018/hitcon/crypto/lostmod/">crypto - Lost Modulus</a></li><li class="chapter"data-level="5.3.2"data-path="../../../../../writeup/2018/hitcon/crypto/secret/"><a href="../../../../../writeup/2018/hitcon/crypto/secret/">crypwn - Secret Note</a></li></ul></li><li class="chapter"data-level="5.4"><span>Hack.lu</span><ul class="articles"><li class="chapter"data-level="5.4.1"data-path="../../../../../writeup/2018/Hack.lu/crypto/escape/"><a href="../../../../../writeup/2018/Hack.lu/crypto/escape/">crypto - Escape the Grid</a></li><li class="chapter"data-level="5.4.2"data-path="../../../../../writeup/2018/Hack.lu/crypto/relation/"><a href="../../../../../writeup/2018/Hack.lu/crypto/relation/">crypto - Relations</a></li><li class="chapter"data-level="5.4.3"data-path="../../../../../writeup/2018/Hack.lu/crypto/lfsr/"><a href="../../../../../writeup/2018/Hack.lu/crypto/lfsr/">crypto - LFSR StreamCipher</a><ul class="articles"><li class="chapter"data-level="5.4.3.1"data-path="../../../../../writeup/2018/Hack.lu/crypto/lfsr/task.html"><a href="../../../../../writeup/2018/Hack.lu/crypto/lfsr/task.html">task description</a></li></ul></li></ul></li><li class="chapter"data-level="5.5"><span>Hackover</span><ul class="articles"><li class="chapter"data-level="5.5.1"data-path="../../../../../writeup/2018/HackOver/crypto/oblivious/"><a href="../../../../../writeup/2018/HackOver/crypto/oblivious/">crypto - oblivious</a></li><li class="chapter"data-level="5.5.2"data-path="../../../../../writeup/2018/HackOver/crypto/secure_hash_v2/"><a href="../../../../../writeup/2018/HackOver/crypto/secure_hash_v2/">crypto - secure_hash_v2</a></li><li class="chapter"data-level="5.5.3"data-path="../../../../../writeup/2018/HackOver/rev/flagmaker/"><a href="../../../../../writeup/2018/HackOver/rev/flagmaker/">rev - flagmaker</a></li></ul></li><li class="chapter"data-level="5.6"><span>Teaser Dragon</span><ul class="articles"><li class="chapter"data-level="5.6.1"data-path="../../../../../writeup/2018/TeaserDragon/rev/Chains of trust/"><a href="../../../../../writeup/2018/TeaserDragon/rev/Chains of trust/">rev - Chains of trust</a></li></ul></li><li class="chapter"data-level="5.7"><span>Defcamp</span><ul class="articles"><li class="chapter"data-level="5.7.1"data-path="../../../../../writeup/2018/defcamp/rev/validator/"><a href="../../../../../writeup/2018/defcamp/rev/validator/">rev - validator</a></li><li class="chapter"data-level="5.7.2"data-path="../../../../../writeup/2018/defcamp/rev/memsome/"><a href="../../../../../writeup/2018/defcamp/rev/memsome/">rev - memsome</a></li><li class="chapter"data-level="5.7.3"data-path="../../../../../writeup/2018/defcamp/web/secops/"><a href="../../../../../writeup/2018/defcamp/web/secops/">web - secops</a></li><li class="chapter"data-level="5.7.4"data-path="../../../../../writeup/2018/defcamp/web/chat/"><a href="../../../../../writeup/2018/defcamp/web/chat/">web - chat</a></li><li class="chapter"data-level="5.7.5"data-path="../../../../../writeup/2018/defcamp/misc/voices/"><a href="../../../../../writeup/2018/defcamp/misc/voices/">misc - voices</a></li></ul></li><li class="chapter"data-level="5.8"><span>HackIT</span><ul class="articles"><li class="chapter"data-level="5.8.1"data-path="../../../../../writeup/2018/HackIT/coffee_overflow/"><a href="../../../../../writeup/2018/HackIT/coffee_overflow/">rev - coffee_overflow</a></li></ul></li><li class="header">My Tasks</li><li class="header">2018</li><li class="chapter"data-level="7.1"><span>AIS3 Final</span><ul class="articles"><li class="chapter"data-level="7.1.1"data-path="../../../../2018/ais3Final/crypto/100-mama/"><a href="../../../../2018/ais3Final/crypto/100-mama/">crypto - mama</a></li><li class="chapter"data-level="7.1.2"data-path="../../../../2018/ais3Final/crypto/200-secureSub/"><a href="../../../../2018/ais3Final/crypto/200-secureSub/">crypto - secureSub</a></li><li class="chapter"data-level="7.1.3"data-path="../../../../2018/ais3Final/crypto/300-xorlnarmoni'akda/"><a href="../../../../2018/ais3Final/crypto/300-xorlnarmoni'akda/">crypto - xorlnarmoni'akda</a></li><li class="chapter"data-level="7.1.4"data-path="../../../../2018/ais3Final/rev/100-SecDES/"><a href="../../../../2018/ais3Final/rev/100-SecDES/">rev - SecDES</a></li><li class="chapter"data-level="7.1.5"data-path="../../../../2018/ais3Final/rev/200-AlmightyDuctTape/"><a href="../../../../2018/ais3Final/rev/200-AlmightyDuctTape/">rev - Almighty Duct Tape</a></li></ul></li><li class="header">2019</li><li class="chapter"data-level="8.1"><span>Balsn CTF</span><ul class="articles"><li class="chapter"data-level="8.1.1"data-path="../../"><a href="../../">Overview</a></li><li class="chapter"data-level="8.1.2"data-path="../../crypto/collision/"><a href="../../crypto/collision/">crypto - collision</a></li><li class="chapter"data-level="8.1.3"data-path="../../crypto/harc4/"><a href="../../crypto/harc4/">crypto - harc4</a></li><li class="chapter"data-level="8.1.4"data-path="../../crypto/unpredictable/"><a href="../../crypto/unpredictable/">crypto - unpredictable</a></li><li class="chapter"data-level="8.1.5"data-path="../../pwn/securenote/"><a href="../../pwn/securenote/">crypwn - securenote</a></li><li class="chapter"data-level="8.1.6"data-path="../../misc/pyshv1/"><a href="../../misc/pyshv1/">misc - pyshv1</a></li><li class="chapter"data-level="8.1.7"data-path="../../misc/pyshv2/"><a href="../../misc/pyshv2/">misc - pyshv2</a></li><li class="chapter"data-level="8.1.8"data-path="../../misc/pyshv3/"><a href="../../misc/pyshv3/">misc - pyshv3</a></li><li class="chapter"data-level="8.1.9"data-path="../../misc/john/"><a href="../../misc/john/">misc - john</a></li><li class="chapter active"data-level="8.1.10"data-path="./"><a href="./">rev - plam</a></li><li class="chapter"data-level="8.1.11"data-path="../vim/"><a href="../vim/">rev - vim</a></li></ul></li><li class="divider"></li><li><a href="https://www.gitbook.com"target="blank"class="gitbook-link">Published with GitBook</a></li></ul></nav></div><div class="book-body"><div class="body-inner"><div class="book-header"role="navigation"><h1><i class="fa fa-circle-o-notch fa-spin"></i> <a href="../../../../..">rev - plam</a></h1></div><div class="page-wrapper"role="main"tabindex="-1"><div class="page-inner"><section class="markdown-section normal"><div class="wpHeaderContainer"><h1 id="plam">plam</h1><div><span><a href="https://github.com/sasdf/ctf/blob/master/tasks/2019/BalsnCTF/rev/plam"target="_blank"><img alt="Attachments"src="https://img.shields.io/badge/-Attachments-lightgrey.svg?style=for-the-badge&amp;maxAge=3600&amp;logo=github"></a></span><span><img alt="reverse - 1000"src="https://img.shields.io/badge/reverse-1000-green.svg?style=for-the-badge&amp;maxAge=3600"></span><span><img alt="1 solves"src="https://img.shields.io/badge/solves-1-lightseagreen.svg?style=for-the-badge&amp;maxAge=3600"></span></div></div><p></p><blockquote><p>I tried my best, but it&apos;s still a little bit slow. It will tell you the result after several years.</p></blockquote><h1 id="overview-concept-and-design-criteria">Overview, Concept and Design Criteria</h1><p>I&apos;m a big fans of lambda calculus. It&apos;s pretty beautiful. Three simple rules but pretty powerful.</p><p>Initially, I was trying to wrote this task with python&apos;s lambda. However, I can&apos;t construct one of the most mind-blown stuff -- fixed point operator, and it&apos;s also difficult to curry those lambdas.</p><p>plam works well before I switched to postfix representation.</p><p>Postfix representation looks pretty great, I have no choice but implement a <a href="https://github.com/sasdf/ctf/blob/master/tasks/2019/BalsnCTF/rev/plam/_files/exec/main.cpp"target="_blank">interpreter</a> by myself to verify the challenge.</p><p>The interpreter is implemented using <a href="https://en.wikipedia.org/wiki/De_Bruijn_index"target="_blank">De Bruijn index</a>. It&apos;s a representation of lambda function which is invariant with respect to &#x3B1;-conversion. With this property, we can cache and retrieve reduction rules in very efficient way.</p><h2 id="designed-criteria">Designed Criteria</h2><p>The core of this flag checker is a system of GF2 (i.e. boolean) linear equations. To avoid it to be guessed, I generate product of 4 sums in each run. So only 1/16 of results will be true, which make blackbox analysis much harder. And also make the code more complicated &#x1F608; .</p><p>Also, I don&apos;t want it to be solved with z3 after you convert those things to boolean operations without understanding them, so I added some branches to it. The complexity will explode for z3.</p><h1 id="solution">Solution</h1><p>You can find the source of that lambda program <a href="https://github.com/sasdf/ctf/blob/master/tasks/2019/BalsnCTF/rev/plam/_files/source/def.txt"target="_blank">here</a>.</p><p>Open the file, you will see a long line consist of these sections:</p><pre class="language-"><code>\abcdefghi.(\j.(...) (...))

(j e e e e e e g e e g g g ... g g e e e e b) (...) (...)

f a e g (c d c c[52] c[12] c[80] c[41] c[48] ... h[57] h h[68] h h[88] h e)

Some other lambda
</code></pre><p>The first part is a closure that load some global functions from its parameters.</p><p>The second part is the return value of this function, it may be the main function. Also, the second and third parts are very long and random, it looks like some embedded data.</p><p>Remaining parts are the definition of global function.</p><p>Term in the form of <code>c[x]</code> or <code>h[x]</code> are input bits.</p><p>if bit x in 0, all <code>c[x]</code> and <code>h[x]</code> will be replaced to <code>c</code> and <code>h</code> when we generating plam script.</p><p>Otherwise, all <code>c[x]</code> and <code>h[x]</code> will be replaced to <code>d</code> and <code>i</code> when we generating plam script.</p><p>Intended solution is understand those lambda and write a solver for it. There&apos;s no other tricks because we don&apos;t even have a interpreter that can run it.</p><p>Let&apos;s try to understand the algorithm with original source code before uglified.</p><h2 id="basic-primitive-types">Basic primitive types</h2><pre class="language-"><code class="lang-python"><span class="token comment"># Boolean [x: true branch, y: false branch]</span>
T <span class="token operator">=</span> &#x3BB;x<span class="token punctuation">.</span>&#x3BB;y<span class="token punctuation">.</span>x    <span class="token comment"># global function e</span>
F <span class="token operator">=</span> &#x3BB;x<span class="token punctuation">.</span>&#x3BB;y<span class="token punctuation">.</span>y    <span class="token comment"># global function g</span>

<span class="token comment"># Pair -- tuple [x: first elem, y: second elem, f: callback(first -&gt; second -&gt; res)]</span>
P <span class="token operator">=</span> &#x3BB;x<span class="token punctuation">.</span>&#x3BB;y<span class="token punctuation">.</span>&#x3BB;f <span class="token punctuation">.</span> f x y

<span class="token comment"># Tree node -- triple [v: node value, r: right, l: left, f: callback(node_value -&gt; right -&gt; left -&gt; res)]</span>
N <span class="token operator">=</span> &#x3BB;v<span class="token punctuation">.</span>&#x3BB;r<span class="token punctuation">.</span>&#x3BB;l<span class="token punctuation">.</span>&#x3BB;f <span class="token punctuation">.</span> f v r l
</code></pre><p>These types are <a href="https://en.wikipedia.org/wiki/Church_encoding"target="_blank">Church encoding</a> of boolean and list.</p><h2 id="postfix-representation">Postfix representation</h2><p>Let&apos;s take a look at section</p><pre class="language-"><code>c d c c[52] c[12] c[80] c[41] c[48] ... h[57] h h[68] h h[88] h e
</code></pre><p>It looks like a list, but it&apos;s actually stack-based tree builder for postfix binary tree representation.</p><pre class="language-"><code class="lang-python"><span class="token comment"># Shift [n: node value, t: top, s: stack, c: callback(top -&gt; stack -&gt; res)]</span>
<span class="token comment"># Pseudo code:</span>
<span class="token comment">#     stack.push(top)</span>
<span class="token comment">#     top = node_value</span>
<span class="token comment">#     return (top, stack)</span>
S <span class="token operator">=</span> &#x3BB;n<span class="token punctuation">.</span>&#x3BB;t<span class="token punctuation">.</span>&#x3BB;s<span class="token punctuation">.</span>&#x3BB;c <span class="token punctuation">.</span> c n <span class="token punctuation">(</span>P t s<span class="token punctuation">)</span>


<span class="token comment"># Reduce [n: node value, t: top, s: stack, c: callback(top -&gt; stack -&gt; res)]</span>
<span class="token comment"># Pseudo code:</span>
<span class="token comment">#     left, right = stack.pop(), top</span>
<span class="token comment">#     top = Node(node_value, right, left)</span>
<span class="token comment">#     return (top, stack)</span>
R <span class="token operator">=</span> &#x3BB;n<span class="token punctuation">.</span>&#x3BB;t<span class="token punctuation">.</span>&#x3BB;s<span class="token punctuation">.</span>&#x3BB;c <span class="token punctuation">.</span> c <span class="token punctuation">(</span>N n t <span class="token punctuation">(</span>s T<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>s F<span class="token punctuation">)</span>

<span class="token comment"># Bind the data to function partially</span>
<span class="token comment"># Type: top -&gt; stack -&gt; next_instruction -&gt; res</span>
A <span class="token operator">=</span> S F    <span class="token comment"># global function c</span>
B <span class="token operator">=</span> S T    <span class="token comment"># global function d</span>
C <span class="token operator">=</span> R F    <span class="token comment"># global function h</span>
D <span class="token operator">=</span> R T    <span class="token comment"># global function i</span>
</code></pre><p>First three characters <code>c d c</code> setup the initial (invalid) state of that builder, so that we can start chaining the function using callback.</p><p>The last instruction <code>e</code> is <code>T</code>, it will take two argument and return the first one, which is the top value (i.e. builded tree).</p><p>Actually, those callback can be replaced by returning tuple, but I think using callback will make it looks more complicated :)</p><h2 id="tree-walking">Tree Walking</h2><p>Now, we have a tree, the main function must walking in that tree.</p><pre class="language-"><code>j = f a e g (tree)
((j e e e e ... g g e e e e b) (...) (...)) ((...) (...) (...)) g ((...) (...) (...)) g
</code></pre><p>The algorithm here is to generate some product of sum boolean expression. And combine them with some branch or AND operation.</p><p>Let&apos;s take a look at implementation.</p><p>In each step, we extract two elements from the tree with two indices.</p><pre class="language-"><code class="lang-python"><span class="token comment"># Unpack1 -- unpack level 1</span>
V <span class="token operator">=</span> &#x3BB;i<span class="token punctuation">.</span>&#x3BB;v<span class="token punctuation">.</span>&#x3BB;r<span class="token punctuation">.</span>&#x3BB;l<span class="token punctuation">.</span>&#x3BB;c <span class="token punctuation">.</span> <span class="token punctuation">(</span>i r l<span class="token punctuation">)</span> <span class="token punctuation">(</span>c v<span class="token punctuation">)</span>

<span class="token comment"># Unpack2 -- unpack level 2</span>
W <span class="token operator">=</span> &#x3BB;j<span class="token punctuation">.</span>&#x3BB;v<span class="token punctuation">.</span>&#x3BB;w<span class="token punctuation">.</span>&#x3BB;r<span class="token punctuation">.</span>&#x3BB;l<span class="token punctuation">.</span>&#x3BB;c <span class="token punctuation">.</span> c v w <span class="token punctuation">(</span>j r l<span class="token punctuation">)</span>

<span class="token comment"># Unpack -- unpack two entries from tree [i: index1, j: index2, l: tree, c: callback(value1 -&gt; value2 -&gt; tree -&gt; res)]</span>
<span class="token comment"># Pseudo code:</span>
<span class="token comment">#    value1 = tree.val</span>
<span class="token comment">#    tree = tree.child[index1]</span>
<span class="token comment">#    value2 = tree.val</span>
<span class="token comment">#    tree = tree.child[index2]</span>
<span class="token comment">#    return (value1, value2, tree)</span>
U <span class="token operator">=</span> &#x3BB;i<span class="token punctuation">.</span>&#x3BB;j<span class="token punctuation">.</span>&#x3BB;l<span class="token punctuation">.</span>&#x3BB;c <span class="token punctuation">.</span> l <span class="token punctuation">(</span>V i<span class="token punctuation">)</span> <span class="token punctuation">(</span>W j<span class="token punctuation">)</span> c
</code></pre><p>And then we change the state based on those elements and the index.</p><pre class="language-"><code class="lang-python"><span class="token comment"># process -- calculate binary function [i: index1, r: result, x: accumulator, v: op, w: val, l: tree, c: callback(result -&gt; accumulator -&gt; tree -&gt; res)]</span>
<span class="token comment"># Pseudo code:</span>
<span class="token comment">#     if index1 == op:</span>
<span class="token comment">#         result &amp;= accumulator</span>
<span class="token comment">#         accumulator = val</span>
<span class="token comment">#     else:</span>
<span class="token comment">#         accumulator ^= val</span>
<span class="token comment">#     return (result, accumulator, tree)</span>

<span class="token comment"># G = \i r x v w l c . (xor i v) ( c r (xor x w) l ) ( c (and r x) w l )</span>
G <span class="token operator">=</span> <span class="token punctuation">(</span>&#x3BB;i<span class="token punctuation">.</span> <span class="token punctuation">(</span>&#x3BB;r<span class="token punctuation">.</span> <span class="token punctuation">(</span>&#x3BB;x<span class="token punctuation">.</span> <span class="token punctuation">(</span>&#x3BB;v<span class="token punctuation">.</span> <span class="token punctuation">(</span>&#x3BB;w<span class="token punctuation">.</span> <span class="token punctuation">(</span>&#x3BB;l<span class="token punctuation">.</span> <span class="token punctuation">(</span>&#x3BB;c<span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token punctuation">(</span><span class="token punctuation">(</span>v F<span class="token punctuation">)</span> T<span class="token punctuation">)</span><span class="token punctuation">)</span> v<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>c r<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token punctuation">(</span><span class="token punctuation">(</span>w F<span class="token punctuation">)</span> T<span class="token punctuation">)</span><span class="token punctuation">)</span> w<span class="token punctuation">)</span><span class="token punctuation">)</span> l<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token punctuation">(</span><span class="token punctuation">(</span>r x<span class="token punctuation">)</span> F<span class="token punctuation">)</span><span class="token punctuation">)</span> w<span class="token punctuation">)</span> l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><p>All op in the path we walked are constant. So the result of <code>(j e ... e b)</code> is product of sums for some boolean expression.</p><h2 id="y-combinator">Y combinator</h2><p>Different from the tree builder that we chaining the functions by callback, we use a fancy technique here -- Y combinator.</p><p>Y combinator is a special function in untyped lambda can be used to define recursive functions.</p><pre class="language-"><code class="lang-python"><span class="token comment"># Y combinator -- An infinite recursive operator</span>
<span class="token comment"># global function f</span>
<span class="token comment"># </span>
<span class="token comment"># Yf = f (Yf)</span>
Y <span class="token operator">=</span> &#x3BB;f <span class="token punctuation">.</span> <span class="token punctuation">(</span>&#x3BB;x <span class="token punctuation">.</span> f <span class="token punctuation">(</span>x x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>&#x3BB;x <span class="token punctuation">.</span> f <span class="token punctuation">(</span>x x<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><p>It looks like it will never stop at first glance.</p><p>Actually, we can stop recursion by stop evaluating the first argument.</p><p>Here&apos;s a simple example of implement addition using Y combinator:</p><pre class="language-"><code class="lang-python">step <span class="token operator">=</span> &#x3BB;f<span class="token punctuation">.</span>&#x3BB;a<span class="token punctuation">.</span>&#x3BB;b<span class="token punctuation">.</span><span class="token punctuation">(</span>
    <span class="token keyword">if</span> b <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> f <span class="token punctuation">(</span>a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>b <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># b == 0</span>
        <span class="token keyword">return</span> a
<span class="token punctuation">)</span>
add <span class="token operator">=</span> &#x3BB;a<span class="token punctuation">.</span>&#x3BB;b<span class="token punctuation">.</span> Y step a b
</code></pre><p>Let&apos;s come back to our reverse challenge:</p><pre class="language-"><code class="lang-python"><span class="token comment"># run -- execute single step in tree [f: recursive, r: result, x: accumulator, l: tree, i: index1, j: index2]</span>
H <span class="token operator">=</span> &#x3BB;f<span class="token punctuation">.</span>&#x3BB;r<span class="token punctuation">.</span>&#x3BB;x<span class="token punctuation">.</span>&#x3BB;l<span class="token punctuation">.</span>&#x3BB;i<span class="token punctuation">.</span>&#x3BB;j <span class="token punctuation">.</span> U i j l <span class="token punctuation">(</span>G i r x<span class="token punctuation">)</span> f

<span class="token comment"># run2 -- Y combinator compatible run</span>
<span class="token comment"># global function a</span>
<span class="token comment"># </span>
<span class="token comment"># Pseudo code:</span>
<span class="token comment">#     while True:</span>
<span class="token comment">#         i, j = input()</span>
<span class="token comment">#         if j is bool:</span>
<span class="token comment">#             result, accumulator, tree = run(result, accumulator, tree, i, j)</span>
<span class="token comment">#         else:</span>
<span class="token comment">#             return (_, _, _, result, accumulator, tree, i, j)</span>
R <span class="token operator">=</span> &#x3BB;f<span class="token punctuation">.</span>&#x3BB;r<span class="token punctuation">.</span>&#x3BB;x<span class="token punctuation">.</span>&#x3BB;l<span class="token punctuation">.</span>&#x3BB;i<span class="token punctuation">.</span>&#x3BB;j <span class="token punctuation">.</span> <span class="token punctuation">(</span>j H H<span class="token punctuation">)</span> f r x l i j

<span class="token comment"># End -- return r</span>
<span class="token comment"># global function b</span>
E <span class="token operator">=</span> &#x3BB;a<span class="token punctuation">.</span>&#x3BB;b<span class="token punctuation">.</span>&#x3BB;f<span class="token punctuation">.</span>&#x3BB;r<span class="token punctuation">.</span>&#x3BB;x<span class="token punctuation">.</span>&#x3BB;l<span class="token punctuation">.</span>&#x3BB;i<span class="token punctuation">.</span>&#x3BB;j <span class="token punctuation">.</span> r
</code></pre><h2 id="combine-boolean-expression">Combine boolean expression</h2><p>We&apos;re almost there, there&apos;s only one missing puzzle.</p><p>We can see those pathes grouped as follows:</p><pre class="language-"><code>((j e e e e ... g g e e e e b) (...) (...)) ((...) (...) (...)) g ((...) (...) (...)) g
</code></pre><p>We already know that <code>(j e ... e b)</code> is a boolean expression. Evaluate a boolean value in Church encoding is branch.</p><pre class="language-"><code class="lang-python">p a b
<span class="token comment"># is equivalent to</span>
<span class="token keyword">if</span> p<span class="token punctuation">:</span>
    <span class="token keyword">return</span> a
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> b

<span class="token comment"># --- #</span>

x y F
<span class="token comment"># is equivalent to</span>
x <span class="token keyword">and</span> y
</code></pre><h2 id="recover-the-flag">Recover the flag</h2><p>After parsing the data, We can figure out that the algorithm looks like:</p><pre class="language-"><code>ret = 1
for i in range(0, 16 * 3, 3):
    if expr[i]:
        ret &amp;= expr[i+1]
    else:
        ret &amp;= expr[i+2]

# All expr are product of 4 sums: (v11 + v12 + ...) &amp; (v21 + v22 + ...) &amp; (v31 + v32 + ...) &amp; (v41 + v42 + ...)
</code></pre><p>The intended solution here is to try all 65536 possible branches and solve the system of linear equations for each branch.</p><p>I solve those equations with sagemath, but I think z3 may also works if you iterate through all those possible branches manually.</p><p>You can find full script <a href="https://github.com/sasdf/ctf/blob/master/tasks/2019/BalsnCTF/rev/plam/_files/solution/solve.sage"target="_blank">here</a>.</p></section></div></div></div><a href="../../misc/john/"class="navigation navigation-prev"aria-label="Previous page: misc - john"><i class="fa fa-angle-left"></i> </a><a href="../vim/"class="navigation navigation-next"aria-label="Next page: rev - vim"><i class="fa fa-angle-right"></i></a></div><script>var gitbook=gitbook||[];gitbook.push(function(){gitbook.page.hasChanged({page:{name:"plam",category:"reverse",points:1e3,solves:1,title:"rev - plam",level:"8.1.10",depth:2,next:{title:"rev - vim",level:"8.1.11",depth:2,path:"tasks/2019/BalsnCTF/rev/vim/README.md",ref:"tasks/2019/BalsnCTF/rev/vim/README.md",articles:[]},previous:{title:"misc - john",level:"8.1.9",depth:2,path:"tasks/2019/BalsnCTF/misc/john/README.md",ref:"tasks/2019/BalsnCTF/misc/john/README.md",articles:[]},dir:"ltr"},config:{gitbook:"*",theme:"default",variables:{},plugins:["katex@git://github.com/sasdf/plugin-katex.git","disqus","prism","-highlight","html-minifier","writeup-utils@git://github.com/sasdf/gitbook-plugin-writeup-utils.git"],pluginsConfig:{prism:{css:["prismjs/themes/prism-tomorrow.css"],lang:{C:"c","C++":"cpp",asm:"nasm"}},disqus:{useIdentifier:!1,shortName:"sasdfwriteup"},search:{maxIndexSize:1e6},"html-minifier":{customAttrSurround:[],removeScriptTypeAttributes:!1,removeEmptyAttributes:!1,removeRedundantAttributes:!1,removeEmptyElements:!1,sortClassName:!0,caseSensitive:!0,html5:!0,collapseWhitespace:!0,processConditionalComments:!1,quoteCharacter:null,keepClosingSlash:!0,preventAttributesEscaping:!1,minifyURLs:!1,removeAttributeQuotes:!1,decodeEntities:!1,trimCustomFragments:!1,customAttrAssign:[],includeAutoGeneratedTags:!0,collapseInlineTagWhitespace:!1,collapseBooleanAttributes:!0,minifyJS:!0,removeTagWhitespace:!0,preserveLineBreaks:!1,sortAttributes:!0,removeStyleLinkTypeAttributes:!1,removeComments:!0,minifyCSS:!0,processScripts:[],conservativeCollapse:!1,removeOptionalTags:!1,useShortDoctype:!1},lunr:{maxIndexSize:1e6,ignoreSpecialCharacters:!1},katex:{},fontsettings:{theme:"white",family:"sans",size:2},sharing:{facebook:!0,twitter:!0,google:!1,weibo:!1,instapaper:!1,vk:!1,all:["facebook","google","twitter","weibo","instapaper"]},"theme-default":{styles:{website:"styles/website.css",pdf:"styles/pdf.css",epub:"styles/epub.css",mobi:"styles/mobi.css",ebook:"styles/ebook.css",print:"styles/print.css"},showLevel:!1},"writeup-utils":{filePrefix:"https://github.com/sasdf/ctf/blob/master",repoPrefix:"https://github.com/sasdf/ctf/blob/master",rawPrefix:"https://raw.githubusercontent.com/sasdf/ctf/master"}},structure:{langs:"LANGS.md",readme:"README.md",glossary:"GLOSSARY.md",summary:"SUMMARY.md"},pdf:{pageNumbers:!0,fontSize:12,fontFamily:"Arial",paperSize:"a4",chapterMark:"pagebreak",pageBreaksBefore:"/",margin:{right:62,left:62,top:56,bottom:56}},styles:{website:"styles/website.css",pdf:"styles/pdf.css",epub:"styles/epub.css",mobi:"styles/mobi.css",ebook:"styles/ebook.css",print:"styles/print.css"}},file:{path:"tasks/2019/BalsnCTF/rev/plam/README.md",mtime:"2020-08-30T20:59:08.271Z",type:"markdown"},gitbook:{version:"3.2.3",time:"2020-08-30T20:59:19.877Z"},basePath:"../../../../..",book:{language:""}})})</script></div><script src="../../../../../gitbook/gitbook.js"></script><script src="../../../../../gitbook/theme.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script><script src="../../../../../gitbook/gitbook-plugin-disqus/plugin.js"></script><script src="../../../../../gitbook/gitbook-plugin-search/lunr.min.js"></script><script src="../../../../../gitbook/gitbook-plugin-search/search.js"></script><script src="../../../../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script><script src="../../../../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script><script src="../../../../../gitbook/gitbook-plugin-sharing/buttons.js"></script><script src="../../../../../gitbook/gitbook-plugin-fontsettings/buttons.js"></script></body></html>