
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>crypwn - securenote Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../../../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../../../../gitbook/gitbook-plugin-katex/katex.min.css">
                
            
                
                <link rel="stylesheet" href="../../../../../gitbook/gitbook-plugin-disqus/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../../../../gitbook/gitbook-plugin-prism/prism-tomorrow.css">
                
            
                
                <link rel="stylesheet" href="../../../../../gitbook/gitbook-plugin-writeup-utils/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../../../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../../../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../../../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../../../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../../misc/pyshv1/" />
    
    
    <link rel="prev" href="../../crypto/unpredictable/" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../../../../">
            
                <a href="../../../../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Writeups</li>
        
        
    

    
        
        <li class="header">2019</li>
        
        
    
        <li class="chapter " data-level="3.1" >
            
                <span>
            
                    
                    Google
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="../../../../../writeup/2019/google/crypto/reality/">
            
                <a href="../../../../../writeup/2019/google/crypto/reality/">
            
                    
                    crypto - reality
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="../../../../../writeup/2019/google/crypto/qkd/">
            
                <a href="../../../../../writeup/2019/google/crypto/qkd/">
            
                    
                    crypto - Quantum Key Distribution
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="../../../../../writeup/2019/google/crypto/cell/">
            
                <a href="../../../../../writeup/2019/google/crypto/cell/">
            
                    
                    crypto - Reverse a cellular automata
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="../../../../../writeup/2019/google/hardware/flagrom/">
            
                <a href="../../../../../writeup/2019/google/hardware/flagrom/">
            
                    
                    hardware - flagrom
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.5" data-path="../../../../../writeup/2019/google/hardware/minetest/">
            
                <a href="../../../../../writeup/2019/google/hardware/minetest/">
            
                    
                    hardware - minetest
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6" data-path="../../../../../writeup/2019/google/hardware/remote/">
            
                <a href="../../../../../writeup/2019/google/hardware/remote/">
            
                    
                    hardware - Remote Control
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7" data-path="../../../../../writeup/2019/google/web/glotto/">
            
                <a href="../../../../../writeup/2019/google/web/glotto/">
            
                    
                    web - gLotto
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8" data-path="../../../../../writeup/2019/google/rev/dial/">
            
                <a href="../../../../../writeup/2019/google/rev/dial/">
            
                    
                    rev - Dialtone
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.2" >
            
                <span>
            
                    
                    Plaid
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.2.1" data-path="../../../../../writeup/2019/plaid/crypto/cypress/">
            
                <a href="../../../../../writeup/2019/plaid/crypto/cypress/">
            
                    
                    crypto - SPlaid Cypress
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.2" data-path="../../../../../writeup/2019/plaid/rev/bigmaffs/">
            
                <a href="../../../../../writeup/2019/plaid/rev/bigmaffs/">
            
                    
                    rev - big maffs
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">2018</li>
        
        
    
        <li class="chapter " data-level="4.1" >
            
                <span>
            
                    
                    hxp
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" data-path="../../../../../writeup/2018/hxp/crypto/blinder_v2/">
            
                <a href="../../../../../writeup/2018/hxp/crypto/blinder_v2/">
            
                    
                    crypto - blinder_v2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2" data-path="../../../../../writeup/2018/hxp/crypto/blinder/">
            
                <a href="../../../../../writeup/2018/hxp/crypto/blinder/">
            
                    
                    crypto - blinder
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3" data-path="../../../../../writeup/2018/hxp/crypto/curve/">
            
                <a href="../../../../../writeup/2018/hxp/crypto/curve/">
            
                    
                    crypto - curve12833227
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4" data-path="../../../../../writeup/2018/hxp/crypto/oops/">
            
                <a href="../../../../../writeup/2018/hxp/crypto/oops/">
            
                    
                    crypto - oops2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5" data-path="../../../../../writeup/2018/hxp/crypto/blind/">
            
                <a href="../../../../../writeup/2018/hxp/crypto/blind/">
            
                    
                    crypto - blind
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.2" >
            
                <span>
            
                    
                    Pwn2Win
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.2.1" data-path="../../../../../writeup/2018/pwn2win/rev/back_to_bletchley_park/">
            
                <a href="../../../../../writeup/2018/pwn2win/rev/back_to_bletchley_park/">
            
                    
                    cryrev - Back To Bletchley Park
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.2" data-path="../../../../../writeup/2018/pwn2win/crypto/GCM/">
            
                <a href="../../../../../writeup/2018/pwn2win/crypto/GCM/">
            
                    
                    crypto - GCM
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.3" >
            
                <span>
            
                    
                    HITCON
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.3.1" data-path="../../../../../writeup/2018/hitcon/crypto/lostmod/">
            
                <a href="../../../../../writeup/2018/hitcon/crypto/lostmod/">
            
                    
                    crypto - Lost Modulus
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3.2" data-path="../../../../../writeup/2018/hitcon/crypto/secret/">
            
                <a href="../../../../../writeup/2018/hitcon/crypto/secret/">
            
                    
                    crypwn - Secret Note
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.4" >
            
                <span>
            
                    
                    Hack.lu
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.4.1" data-path="../../../../../writeup/2018/Hack.lu/crypto/escape/">
            
                <a href="../../../../../writeup/2018/Hack.lu/crypto/escape/">
            
                    
                    crypto - Escape the Grid
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4.2" data-path="../../../../../writeup/2018/Hack.lu/crypto/relation/">
            
                <a href="../../../../../writeup/2018/Hack.lu/crypto/relation/">
            
                    
                    crypto - Relations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4.3" data-path="../../../../../writeup/2018/Hack.lu/crypto/lfsr/">
            
                <a href="../../../../../writeup/2018/Hack.lu/crypto/lfsr/">
            
                    
                    crypto - LFSR StreamCipher
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.4.3.1" data-path="../../../../../writeup/2018/Hack.lu/crypto/lfsr/task.html">
            
                <a href="../../../../../writeup/2018/Hack.lu/crypto/lfsr/task.html">
            
                    
                    task description
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.5" >
            
                <span>
            
                    
                    Hackover
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.5.1" data-path="../../../../../writeup/2018/HackOver/crypto/oblivious/">
            
                <a href="../../../../../writeup/2018/HackOver/crypto/oblivious/">
            
                    
                    crypto - oblivious
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5.2" data-path="../../../../../writeup/2018/HackOver/crypto/secure_hash_v2/">
            
                <a href="../../../../../writeup/2018/HackOver/crypto/secure_hash_v2/">
            
                    
                    crypto - secure_hash_v2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5.3" data-path="../../../../../writeup/2018/HackOver/rev/flagmaker/">
            
                <a href="../../../../../writeup/2018/HackOver/rev/flagmaker/">
            
                    
                    rev - flagmaker
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.6" >
            
                <span>
            
                    
                    Teaser Dragon
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.6.1" data-path="../../../../../writeup/2018/TeaserDragon/rev/Chains of trust/">
            
                <a href="../../../../../writeup/2018/TeaserDragon/rev/Chains of trust/">
            
                    
                    rev - Chains of trust
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.7" >
            
                <span>
            
                    
                    Defcamp
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.7.1" data-path="../../../../../writeup/2018/defcamp/rev/validator/">
            
                <a href="../../../../../writeup/2018/defcamp/rev/validator/">
            
                    
                    rev - validator
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.7.2" data-path="../../../../../writeup/2018/defcamp/rev/memsome/">
            
                <a href="../../../../../writeup/2018/defcamp/rev/memsome/">
            
                    
                    rev - memsome
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.7.3" data-path="../../../../../writeup/2018/defcamp/web/secops/">
            
                <a href="../../../../../writeup/2018/defcamp/web/secops/">
            
                    
                    web - secops
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.7.4" data-path="../../../../../writeup/2018/defcamp/web/chat/">
            
                <a href="../../../../../writeup/2018/defcamp/web/chat/">
            
                    
                    web - chat
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.7.5" data-path="../../../../../writeup/2018/defcamp/misc/voices/">
            
                <a href="../../../../../writeup/2018/defcamp/misc/voices/">
            
                    
                    misc - voices
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.8" >
            
                <span>
            
                    
                    HackIT
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.8.1" data-path="../../../../../writeup/2018/HackIT/coffee_overflow/">
            
                <a href="../../../../../writeup/2018/HackIT/coffee_overflow/">
            
                    
                    rev - coffee_overflow
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">My Tasks</li>
        
        
    

    
        
        <li class="header">2018</li>
        
        
    
        <li class="chapter " data-level="6.1" >
            
                <span>
            
                    
                    AIS3 Final
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="6.1.1" data-path="../../../../2018/ais3Final/crypto/100-mama/">
            
                <a href="../../../../2018/ais3Final/crypto/100-mama/">
            
                    
                    crypto - mama
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.2" data-path="../../../../2018/ais3Final/crypto/200-secureSub/">
            
                <a href="../../../../2018/ais3Final/crypto/200-secureSub/">
            
                    
                    crypto - secureSub
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.3" data-path="../../../../2018/ais3Final/crypto/300-xorlnarmoni'akda/">
            
                <a href="../../../../2018/ais3Final/crypto/300-xorlnarmoni'akda/">
            
                    
                    crypto - xorlnarmoni'akda
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.4" data-path="../../../../2018/ais3Final/rev/100-SecDES/">
            
                <a href="../../../../2018/ais3Final/rev/100-SecDES/">
            
                    
                    rev - SecDES
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.5" data-path="../../../../2018/ais3Final/rev/200-AlmightyDuctTape/">
            
                <a href="../../../../2018/ais3Final/rev/200-AlmightyDuctTape/">
            
                    
                    rev - Almighty Duct Tape
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">2019</li>
        
        
    
        <li class="chapter " data-level="7.1" >
            
                <span>
            
                    
                    Balsn CTF
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="7.1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.1.2" data-path="../../crypto/collision/">
            
                <a href="../../crypto/collision/">
            
                    
                    crypto - collision
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.1.3" data-path="../../crypto/harc4/">
            
                <a href="../../crypto/harc4/">
            
                    
                    crypto - harc4
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.1.4" data-path="../../crypto/unpredictable/">
            
                <a href="../../crypto/unpredictable/">
            
                    
                    crypto - unpredictable
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="7.1.5" data-path="./">
            
                <a href="./">
            
                    
                    crypwn - securenote
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.1.6" data-path="../../misc/pyshv1/">
            
                <a href="../../misc/pyshv1/">
            
                    
                    misc - pyshv1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.1.7" data-path="../../misc/pyshv2/">
            
                <a href="../../misc/pyshv2/">
            
                    
                    misc - pyshv2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.1.8" data-path="../../misc/pyshv3/">
            
                <a href="../../misc/pyshv3/">
            
                    
                    misc - pyshv3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.1.9" data-path="../../misc/john/">
            
                <a href="../../misc/john/">
            
                    
                    misc - john
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.1.10" data-path="../../rev/plam/">
            
                <a href="../../rev/plam/">
            
                    
                    rev - plam
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.1.11" data-path="../../rev/vim/">
            
                <a href="../../rev/vim/">
            
                    
                    rev - vim
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../../../.." >crypwn - securenote</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div class="wpHeaderContainer">
                    <h1 id="securenote">securenote</h1>
                    <div>
                        <span><a href="https://github.com/sasdf/ctf/blob/master/tasks/2019/BalsnCTF/pwn/securenote" target="_blank"><img src="https://img.shields.io/badge/-Attachments-lightgrey.svg?style=for-the-badge&amp;maxAge=3600&amp;logo=github" alt="Attachments"></a></span><span><img src="https://img.shields.io/badge/crypwn-1000-green.svg?style=for-the-badge&amp;maxAge=3600" alt="crypwn - 1000"></span><span><img src="https://img.shields.io/badge/solves-0-lightseagreen.svg?style=for-the-badge&amp;maxAge=3600" alt="0 solves"></span></div>
                </div><p></p>
<blockquote>
<p>Notes family is known to be pwned, we secure it with SOTA encryption.
There&apos;s nothing you can control.</p>
</blockquote>
<h1 id="overview-concept-and-design-criteria">Overview, Concept and Design Criteria</h1>
<p>This challenge is inspired by another crypto-pwn challenge, <code>secret note</code>, from HITCON CTF 2018.</p>
<p>The way they mixed different field is pretty great,
and I was trying to design another one by myself.</p>
<p>The main design criteria is that it should be a mixed challenge,
not just a multi-level challenge.</p>
<p>That is, you have to know how2crypto to find where to pwn,
while you also need to know how2pwn to break the cipher.
And, again, you need to know how2crypto to fully pwn the program.
So... do you know how2hack?</p>
<h1 id="solution">Solution</h1>
<h2 id="tldr">TL;DR</h2>
<ol>
<li>Create free chunk near the counter</li>
<li>Overflow to chunksize of top chunk</li>
<li>Allocate some chunk to change the terminator</li>
<li>Get the keystream for printing heap content</li>
<li>Create overlapped chunk by modifying the size</li>
<li>Partial overwrite to forge fd to counter</li>
<li>Reset counter</li>
<li>Get the keystream for writing</li>
<li>Use normal heap exploitation techniques to win</li>
</ol>
<h2 id="recap-aes-counter-mode--nonce-reuse">Recap: AES Counter mode &amp; nonce reuse</h2>
<p>If you&apos;re not familiar with crypto, let me recap some property of AES-CTR we need.</p>
<ul>
<li>Just assume AES is a blackbox and don&apos;t dig into it.</li>
<li>Encrypting in CTR mode is just xor plaintext with some random, secure, unknown keystream.</li>
<li>We can recover keystream given a plain/ciphertext pair because they&apos;re just xored together.</li>
<li>Keystream is always the same for same counter.</li>
</ul>
<p>With these property, let&apos;s look the goal again:
If we leak the keystream and then reset the counter,
we can control ciphertext because we already knew what will be xored to our plaintext.</p>
<p>The first goal of crypto part is pwning the program to reset the counter, so that we can control the data on heap.</p>
<h2 id="off-by-one">Off by one</h2>
<p>The code about creating a new note looks like:</p>
<pre class="language-"><code class="lang-c"><span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> nbyte <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>buf<span class="token punctuation">[</span>nbyte <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&apos;\n&apos;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    buf<span class="token punctuation">[</span>nbyte <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">char</span><span class="token operator">*</span> note <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>nbyte<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">strcpy</span><span class="token punctuation">(</span>note<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Instead of allocate <code>strlen(buf) + 1</code> bytes, we only allocate the number of bytes we read.</p>
<p>When there&apos;s no <code>\0</code> or <code>\n</code> in the string,
strcpy will copy one more null byte,
result in one byte heap overflow.</p>
<p>With this vulnerability,
we can modify the size of next chunk,
and exploit it with some well-known heap tricks.</p>
<p>However, we still can&apos;t control the content we write.</p>
<h2 id="leak-keystream">Leak keystream</h2>
<p>First, let&apos;s see how to leak the content (i.e. ciphertext) on heap.</p>
<p>Originally, I create a overlapped chunk and change the terminator byte on the next note.
But @Billy found a more brilliant way to do this.</p>
<p>Create a chunk with overflow to top chunk&apos;s size,
which means that the terminator is the last byte of top chunk&apos;s size.</p>
<p>When you allocate one more chunk,
the size (i.e. the terminator) will be changed,
and it will print excessive bytes and leak ciphertext of heap.</p>
<p>Those content on heap are known (default is zero),
and we have corresponding ciphertext.
XOR them together reveals the keystream of our leaker note.</p>
<h2 id="reset-counter">Reset counter</h2>
<p>Now, how can we reset the counter?</p>
<p>With overlapped chunk,
we can modify heap but we can&apos;t control the content we write.</p>
<p>Deadend.</p>
<p>Actually, we have another way to modify heap -- free.</p>
<p>When we free a chunk, 
the address to free chunk list will be write to the first 8 bytes (i.e. fd).</p>
<p>On the other hand, when we allocate a chunk,
the first 8 bytes will be copied back to libc as the pointer of next chunk.</p>
<p>After we allocate on counter,
free it and then allocate it back will reset it to some unknown but fixed value.</p>
<h2 id="allocate-on-counter">Allocate on counter</h2>
<p>To allocate on counter,
we can exploit tcache.</p>
<p>First, we create a free chunk near the counter,
and let another free chunk&apos;s fd points to it.</p>
<p>And then partial overwrite fd to make it points to the counter.</p>
<p>Another way is to forge it byte-by-byte,
but it requires a super low latency network due to the large amount of operation needed.</p>
<p>To avoid giving adventange to someone who has better network,
I blocked this method by limiting the number of operation in one connection.</p>
<h2 id="pwned">Pwned</h2>
<p>Once we are able to reset the counter,
we can control the content on heap.</p>
<p>The remaining parts are just as same as classic heap exploitation.</p>
<p>In my solution, I modify a tcache chunk&apos;s fd to mallochook and write onegadget to it.</p>
<p>My teammate use another solution by setting freehook to system.</p>
<p>There are many ways to pwn it in this step, just choice the one you like.</p>
<p>You can find my exploit <a href="https://github.com/sasdf/ctf/blob/master/tasks/2019/BalsnCTF/pwn/securenote/_files/solution/solve.py" target="_blank">here</a>.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../../crypto/unpredictable/" class="navigation navigation-prev " aria-label="Previous page: crypto - unpredictable">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../../misc/pyshv1/" class="navigation navigation-next " aria-label="Next page: misc - pyshv1">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"name":"securenote","category":"crypwn","points":1000,"solves":0,"title":"crypwn - securenote","level":"7.1.5","depth":2,"next":{"title":"misc - pyshv1","level":"7.1.6","depth":2,"path":"tasks/2019/BalsnCTF/misc/pyshv1/README.md","ref":"tasks/2019/BalsnCTF/misc/pyshv1/README.md","articles":[]},"previous":{"title":"crypto - unpredictable","level":"7.1.4","depth":2,"path":"tasks/2019/BalsnCTF/crypto/unpredictable/README.md","ref":"tasks/2019/BalsnCTF/crypto/unpredictable/README.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["katex@git://github.com/sasdf/plugin-katex.git","disqus","prism","-highlight","html-minifier","writeup-utils@git://github.com/sasdf/gitbook-plugin-writeup-utils.git"],"pluginsConfig":{"prism":{"css":["prismjs/themes/prism-tomorrow.css"],"lang":{"C":"c","C++":"cpp","asm":"nasm"}},"disqus":{"useIdentifier":false,"shortName":"sasdfwriteup"},"search":{},"html-minifier":{"customAttrSurround":[],"removeScriptTypeAttributes":false,"removeEmptyAttributes":false,"removeRedundantAttributes":false,"removeEmptyElements":false,"sortClassName":true,"caseSensitive":true,"html5":true,"collapseWhitespace":true,"processConditionalComments":false,"quoteCharacter":null,"keepClosingSlash":true,"preventAttributesEscaping":false,"minifyURLs":false,"removeAttributeQuotes":false,"decodeEntities":false,"trimCustomFragments":false,"customAttrAssign":[],"includeAutoGeneratedTags":true,"collapseInlineTagWhitespace":false,"collapseBooleanAttributes":true,"minifyJS":true,"removeTagWhitespace":true,"preserveLineBreaks":false,"sortAttributes":true,"removeStyleLinkTypeAttributes":false,"removeComments":true,"minifyCSS":true,"processScripts":[],"conservativeCollapse":false,"removeOptionalTags":false,"useShortDoctype":false},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"katex":{},"fontsettings":{"theme":"white","family":"sans","size":2},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"writeup-utils":{"filePrefix":"https://github.com/sasdf/ctf/blob/master","repoPrefix":"https://github.com/sasdf/ctf/blob/master","rawPrefix":"https://raw.githubusercontent.com/sasdf/ctf/master"}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"tasks/2019/BalsnCTF/pwn/securenote/README.md","mtime":"2019-10-08T10:46:19.022Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-10-08T16:03:03.756Z"},"basePath":"../../../../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../../../../gitbook/gitbook.js"></script>
    <script src="../../../../../gitbook/theme.js"></script>
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
        
    
        
        <script src="../../../../../gitbook/gitbook-plugin-disqus/plugin.js"></script>
        
    
        
        <script src="../../../../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../../../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../../../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../../../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../../../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../../../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

